{% extends "fincore/base.html" %}
{% block title %}Transactions · Fincore{% endblock %}

{% block content %}
<div class="space-y-4 flex flex-col h-full" x-data="{ uploadOpen: false }" @open-import.window="uploadOpen = true">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Transactions</h1>
      <p class="text-sm text-slate-500">View and manage transaction records</p>
    </div>
    <div class="flex items-center gap-2">
      <button class="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50" @click="$dispatch('open-import')">
        <svg class="h-4 w-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 10.5 21 6m0 0-4.5-4.5M21 6h-6a2.25 2.25 0 0 0-2.25 2.25V21M8.25 9.75H6.75A2.25 2.25 0 0 0 4.5 12v6a2.25 2.25 0 0 0 2.25 2.25h6a2.25 2.25 0 0 0 2.25-2.25v-1.5" /></svg>
        Upload .CSV
      </button>
      <button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700">New Transaction</button>
    </div>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm flex flex-col flex-1 min-h-[calc(100vh-220px)]" id="transactions-table" hx-get="{% url 'fincore:transaction_table' %}" hx-trigger="load"></div>
</div>

<!-- Import CSV wizard modal -->
<div
  x-data="importWizard()"
  x-on:open-import.window="uploadOpen = true"
  x-cloak
  x-show="uploadOpen"
  class="fixed inset-0 z-50 flex items-start justify-center overflow-y-auto bg-slate-900/40 p-4"
  role="dialog"
  aria-modal="true"
>
  <div x-transition.scale.origin.top class="w-full max-w-2xl rounded-lg border border-slate-200 bg-white shadow-lg">
    <div class="flex items-center justify-between border-b border-slate-200 p-4">
      <h2 class="text-sm font-medium text-slate-700">Upload CSV File</h2>
      <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" @click="uploadOpen = false; resetWizard()" aria-label="Close">✕</button>
    </div>
    <div class="p-4 space-y-4">
      <div class="flex items-center gap-2 text-xs font-semibold text-slate-600">
        <template x-for="(label, index) in steps" :key="index">
          <div class="flex items-center gap-2">
            <div class="flex h-6 w-6 items-center justify-center rounded-full border" :class="currentStep > index ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : currentStep === index ? 'border-indigo-500 text-indigo-700' : 'border-slate-200 text-slate-400'">
              <span x-text="index + 1"></span>
            </div>
            <span x-text="label"></span>
            <template x-if="index < steps.length - 1">
              <span class="text-slate-300">/</span>
            </template>
          </div>
        </template>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4" x-show="currentStep === 0">
        <h3 class="text-sm font-semibold text-slate-800">1) Upload CSV</h3>
        <p class="text-xs text-slate-500 mb-3">Accepted: .csv · Max 10MB.</p>
        <input type="file" accept=".csv" class="block w-full cursor-pointer rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm file:mr-3 file:cursor-pointer file:rounded-md file:border-0 file:bg-indigo-600 file:px-4 file:py-2 file:text-sm file:font-medium file:text-white hover:file:bg-indigo-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          @change="onFileSelect">
        <p class="mt-2 text-xs text-slate-600" x-text="fileName ? `Selected: ${fileName}` : 'No file selected'"></p>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 1">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-sm font-semibold text-slate-800">2) Column mapping</h3>
            <p class="text-xs text-slate-500">Map exactly one column to Date, Description, Amount. Everything else → Ignore. Kind/Category/Transfer/Account mappings are forbidden.</p>
          </div>
          <p class="text-xs font-semibold" :class="mappingComplete() ? 'text-emerald-600' : 'text-amber-600'" x-text="mappingComplete() ? 'Ready' : 'Incomplete'"></p>
        </div>
        <div class="overflow-hidden rounded border border-slate-200 bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-3 py-2 text-left">CSV Column</th>
                <th class="px-3 py-2 text-left">Map to</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="col in columns" :key="col">
                <tr>
                  <td class="px-3 py-2 font-medium text-slate-700" x-text="col"></td>
                  <td class="px-3 py-2">
                    <select class="w-48 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
                      x-model="mappings[col]">
                      <option value="ignore">Ignore</option>
                      <option value="date">Date</option>
                      <option value="description">Description</option>
                      <option value="amount">Amount</option>
                    </select>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 2">
        <h3 class="text-sm font-semibold text-slate-800">3) Preview (first 10 rows)</h3>
        <div class="overflow-auto rounded border border-slate-200 bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-3 py-2 text-left">Date</th>
                <th class="px-3 py-2 text-left">Description</th>
                <th class="px-3 py-2 text-left">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="row in previewRows" :key="row.id">
                <tr>
                  <td class="px-3 py-2 text-slate-800" x-text="row.date"></td>
                  <td class="px-3 py-2 text-slate-800" x-text="row.description"></td>
                  <td class="px-3 py-2 text-slate-800" x-text="row.amount"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 3">
        <h3 class="text-sm font-semibold text-slate-800">4) Select account</h3>
        <p class="text-xs text-slate-500">Required. Account type guides validation (credit_card, debit_card, bank).</p>
        <select class="w-64 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model="selectedAccount">
          <option value="">Choose account</option>
          <template x-for="acct in accounts" :key="acct.id">
            <option :value="acct.id" x-text="`${acct.name} (${acct.type})`"></option>
          </template>
        </select>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-2" x-show="currentStep === 4">
        <h3 class="text-sm font-semibold text-slate-800">5) Confirm import</h3>
        <ul class="list-disc pl-5 text-xs text-slate-700 space-y-1">
          <li>All rows will be marked imported and linked to one import batch.</li>
          <li>Amount &lt; 0 → Expense, Amount &gt; 0 → Income.</li>
          <li>Category and Payee will be empty; no auto-transfers or balances used.</li>
          <li>Rollback is only allowed per import batch (never partial).</li>
        </ul>
      </div>
    </div>
    <div class="flex items-center justify-between border-t border-slate-200 p-4">
      <button class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" @click="uploadOpen = false; resetWizard()">Cancel</button>
      <div class="flex items-center gap-2">
        <template x-if="currentStep < steps.length -1">
          <button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-60" :disabled="!canNext()" @click="nextStep()">Next</button>
        </template>
        <template x-if="currentStep === steps.length -1">
          <button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-60" :disabled="!canConfirm()" @click="uploadOpen=false; resetWizard()">Confirm import</button>
        </template>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
{{ block.super }}
<script>
  function importWizard() {
    const sampleRows = [
      { id: 1, date: "2024-10-12", description: "Client Invoice", amount: "+$1,200.00" },
      { id: 2, date: "2024-10-11", description: "Office Supplies", amount: "-$180.00" },
      { id: 3, date: "2024-10-10", description: "Subscription", amount: "-$45.00" },
      { id: 4, date: "2024-10-09", description: "Consulting Revenue", amount: "+$1,250.00" },
      { id: 5, date: "2024-10-09", description: "Bank Transfer", amount: "+$500.00" },
      { id: 6, date: "2024-10-08", description: "Travel", amount: "-$320.00" },
      { id: 7, date: "2024-10-07", description: "Refund", amount: "+$220.00" },
      { id: 8, date: "2024-10-06", description: "Payroll", amount: "-$1,800.00" },
      { id: 9, date: "2024-10-05", description: "Stripe Payout", amount: "+$980.00" },
      { id: 10, date: "2024-10-04", description: "Hosting", amount: "-$65.00" },
    ];
    const cols = ["Txn Date", "Details", "Amount", "Balance"];
    const defaultMap = {};
    cols.forEach((c) => (defaultMap[c] = "ignore"));

    return {
      steps: ["Upload", "Map", "Preview", "Account", "Confirm"],
      currentStep: 0,
      fileName: "",
      uploadOpen: false,
      columns: cols,
      mappings: { ...defaultMap },
      previewRows: sampleRows,
      accounts: [
        { id: "acc-bank-1", name: "Operating Checking", type: "bank" },
        { id: "acc-cc-1", name: "Corporate Card", type: "credit_card" },
        { id: "acc-db-1", name: "Debit Card", type: "debit_card" },
      ],
      selectedAccount: "",
      resetWizard() {
        this.currentStep = 0;
        this.fileName = "";
        this.mappings = { ...defaultMap };
        this.selectedAccount = "";
      },
      onFileSelect(event) {
        const file = event.target.files[0];
        this.fileName = file ? file.name : "";
      },
      mappingComplete() {
        const values = Object.values(this.mappings);
        const hasDate = values.filter((v) => v === "date").length === 1;
        const hasDesc = values.filter((v) => v === "description").length === 1;
        const hasAmount = values.filter((v) => v === "amount").length === 1;
        return hasDate && hasDesc && hasAmount;
      },
      canNext() {
        if (this.currentStep === 0) return !!this.fileName;
        if (this.currentStep === 1) return this.mappingComplete();
        if (this.currentStep === 3) return !!this.selectedAccount;
        return true;
      },
      canConfirm() {
        return !!this.selectedAccount && this.mappingComplete() && !!this.fileName;
      },
      nextStep() {
        if (this.canNext()) this.currentStep = Math.min(this.steps.length - 1, this.currentStep + 1);
      },
      prevStep() {
        this.currentStep = Math.max(0, this.currentStep - 1);
      },
    };
  }
</script>
{% endblock %}
