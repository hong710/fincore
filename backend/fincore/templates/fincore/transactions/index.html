{% extends "fincore/base.html" %}
{% block title %}Transactions · Fincore{% endblock %}

{% block content %}
<div class="space-y-4 flex flex-col h-full" x-data="{ uploadOpen: false }" @open-import.window="uploadOpen = true">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Transactions</h1>
      <p class="text-sm text-slate-500">View and manage transaction records</p>
    </div>
    <div class="flex items-center gap-2">
      <button class="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50" @click="$dispatch('open-import')">
        <svg class="h-4 w-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 10.5 21 6m0 0-4.5-4.5M21 6h-6a2.25 2.25 0 0 0-2.25 2.25V21M8.25 9.75H6.75A2.25 2.25 0 0 0 4.5 12v6a2.25 2.25 0 0 0 2.25 2.25h6a2.25 2.25 0 0 0 2.25-2.25v-1.5" /></svg>
        Upload .CSV
      </button>
      <button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700" data-hs-overlay="#new-transaction-modal">+ New Transaction</button>
    </div>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm flex flex-col flex-1 min-h-[calc(100vh-220px)]" id="transactions-table" hx-get="{% url 'fincore:transaction_table' %}" hx-trigger="load"></div>
</div>

<div id="new-transaction-modal" class="hs-overlay hidden fixed inset-0 z-50 overflow-y-auto" tabindex="-1">
  <div class="fixed inset-0 bg-slate-900/40"></div>
  <div class="relative flex min-h-full items-center justify-center p-4">
    <div class="w-full max-w-xl rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">New Transaction</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" data-hs-overlay="#new-transaction-modal" aria-label="Close">✕</button>
      </div>
      <form class="space-y-4 p-4">
        <div class="grid gap-3 sm:grid-cols-2">
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Date</span>
            <input type="date" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Account</span>
            <select class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">Choose account</option>
              {% for acct in accounts %}
                <option value="{{ acct.id }}">{{ acct.name }} ({{ acct.account_type }})</option>
              {% endfor %}
            </select>
          </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Kind</span>
            <select class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="transfer">Transfer</option>
              <option value="opening">Opening</option>
            </select>
          </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Amount</span>
            <input type="number" step="0.01" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00">
          </label>
        </div>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Payee</span>
          <input type="text" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional">
        </label>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Description</span>
          <textarea rows="3" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional"></textarea>
        </label>
        <div class="flex items-center justify-end gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" data-hs-overlay="#new-transaction-modal">Cancel</button>
          <button type="button" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white opacity-60" disabled>Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="bulk-action-modal" class="hs-overlay hidden fixed inset-0 z-50 overflow-y-auto" tabindex="-1">
  <div class="fixed inset-0 bg-slate-900/40"></div>
  <div class="relative flex min-h-full items-center justify-center p-4">
    <div class="w-full max-w-lg rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">Bulk Action</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" data-hs-overlay="#bulk-action-modal" aria-label="Close">✕</button>
      </div>
      <form class="space-y-4 p-4">
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Action</span>
          <select class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="payee">Payee</option>
            <option value="category">Category</option>
            <option value="delete">Delete</option>
          </select>
        </label>
        <p class="text-xs text-slate-500">Delete is allowed only for manually created transactions.</p>
        <div class="flex items-center justify-end gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" data-hs-overlay="#bulk-action-modal">Cancel</button>
          <button type="button" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white opacity-60" disabled>Apply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Import CSV wizard modal -->
<div
  x-data="importWizard()"
  x-on:open-import.window="uploadOpen = true"
  x-on:import:staged.window="importDone = true"
  x-cloak
  x-show="uploadOpen"
  class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto bg-slate-900/40 p-4"
  role="dialog"
  aria-modal="true"
>
  <div x-transition.scale.origin.top class="w-full max-w-2xl rounded-lg border border-slate-200 bg-white shadow-lg">
    <div class="flex items-center justify-between border-b border-slate-200 p-4">
      <h2 class="text-sm font-medium text-slate-700">Upload CSV File</h2>
      <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" @click="uploadOpen = false; resetWizard()" aria-label="Close">✕</button>
    </div>
    <form
      class="space-y-0"
      enctype="multipart/form-data"
      hx-encoding="multipart/form-data"
      hx-post="{% url 'fincore:import_stage' %}"
      hx-target="#import-feedback"
      hx-swap="innerHTML"
      hx-on:htmx:beforeRequest="isSubmitting = true"
      hx-on:htmx:afterRequest="isSubmitting = false"
    >
      <div class="p-4 space-y-4">
        <div id="import-feedback" class="text-sm"></div>
        <input type="hidden" name="account_id" :value="selectedAccount">
        <input type="hidden" name="mapping" :value="JSON.stringify(mappings)">
      <div class="flex items-center gap-2 text-xs font-semibold text-slate-600">
        <template x-for="(label, index) in steps" :key="index">
          <div class="flex items-center gap-2">
            <div class="flex h-6 w-6 items-center justify-center rounded-full border" :class="currentStep > index ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : currentStep === index ? 'border-indigo-500 text-indigo-700' : 'border-slate-200 text-slate-400'">
              <span x-text="index + 1"></span>
            </div>
            <span x-text="label"></span>
            <template x-if="index < steps.length - 1">
              <span class="text-slate-300">/</span>
            </template>
          </div>
        </template>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4" x-show="currentStep === 0">
        <h3 class="text-sm font-semibold text-slate-800">1) Upload CSV</h3>
        <p class="text-xs text-slate-500 mb-3">Accepted: .csv · Max 10MB.</p>
        <input type="file" name="csv_file" accept=".csv" class="block w-full cursor-pointer rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm file:mr-3 file:cursor-pointer file:rounded-md file:border-0 file:bg-indigo-600 file:px-4 file:py-2 file:text-sm file:font-medium file:text-white hover:file:bg-indigo-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          @change="onFileSelect">
        <p class="mt-2 text-xs text-slate-600" x-text="fileName ? `Selected: ${fileName}` : 'No file selected'"></p>
        <p class="mt-2 text-xs text-rose-600" x-show="fileError" x-text="fileError"></p>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 1">
        <h3 class="text-sm font-semibold text-slate-800">2) Select account</h3>
        <p class="text-xs text-slate-500">Required. Account type guides validation (credit_card, debit_card, bank).</p>
        <select class="w-64 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model="selectedAccount">
          <option value="">Choose account</option>
          <template x-for="acct in accounts" :key="acct.id">
            <option :value="acct.id" x-text="`${acct.name} (${acct.type})`"></option>
          </template>
        </select>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 2">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-sm font-semibold text-slate-800">3) Column mapping</h3>
            <p class="text-xs text-slate-500">Map exactly one column to Date, Description, Amount. Everything else → Ignore. Kind/Category/Transfer/Account mappings are forbidden.</p>
          </div>
          <p class="text-xs font-semibold" :class="mappingComplete() ? 'text-emerald-600' : 'text-amber-600'" x-text="mappingComplete() ? 'Ready' : 'Incomplete'"></p>
        </div>
        <div class="overflow-hidden rounded border border-slate-200 bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-3 py-2 text-left">CSV Column</th>
                <th class="px-3 py-2 text-left">Map to</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="col in columns" :key="col">
                <tr>
                  <td class="px-3 py-2 font-medium text-slate-700" x-text="col"></td>
                  <td class="px-3 py-2">
                    <select class="w-48 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
                      x-model="mappings[col]" @change="updatePreview()">
                      <option value="ignore">Ignore</option>
                      <option value="date">Date</option>
                      <option value="description">Description</option>
                      <option value="amount">Amount</option>
                    </select>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 3">
        <h3 class="text-sm font-semibold text-slate-800">4) Preview (first 10 rows)</h3>
        <div class="overflow-auto rounded border border-slate-200 bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-3 py-2 text-left">Date</th>
                <th class="px-3 py-2 text-left">Description</th>
                <th class="px-3 py-2 text-left">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="row in previewRows" :key="row.id">
                <tr>
                  <td class="px-3 py-2 text-slate-800" x-text="row.date"></td>
                  <td class="px-3 py-2 text-slate-800" x-text="row.description"></td>
                  <td class="px-3 py-2 text-slate-800" x-text="row.amount"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-2" x-show="currentStep === 4">
        <h3 class="text-sm font-semibold text-slate-800">5) Confirm import</h3>
        <ul class="list-disc pl-5 text-xs text-slate-700 space-y-1">
          <li>All rows will be marked imported and linked to one import batch.</li>
          <li>Amount &lt; 0 → Expense, Amount &gt; 0 → Income.</li>
          <li>Category and Payee will be empty; no auto-transfers or balances used.</li>
          <li>Rollback is only allowed per import batch (never partial).</li>
        </ul>
      </div>
    </div>
      <div class="flex items-center justify-between border-t border-slate-200 p-4">
        <div class="flex items-center gap-2 text-xs text-slate-600" x-show="isSubmitting" x-cloak>
          <span class="h-3.5 w-3.5 animate-spin rounded-full border-2 border-slate-300 border-t-indigo-600"></span>
          <span>Uploading and validating...</span>
        </div>
        <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50 disabled:opacity-60" :disabled="isSubmitting" @click="uploadOpen = false; resetWizard()">Cancel</button>
        <div class="flex items-center gap-2">
          <template x-if="currentStep < steps.length -1">
            <button type="button" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-60" :disabled="isSubmitting || !canNext()" @click="nextStep()">Next</button>
          </template>
          <template x-if="currentStep === steps.length -1">
            <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-60" :disabled="importDone || isSubmitting || !canConfirm()">Confirm import</button>
          </template>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block body_extra %}
{{ block.super }}
{{ accounts|json_script:"import-accounts-data" }}
{{ prefill_account_id|json_script:"import-prefill-account" }}
<script>
  function importWizard() {
    const parseCSVLine = (line) => {
      const cells = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === "," && !inQuotes) {
          cells.push(current);
          current = "";
        } else {
          current += char;
        }
      }
      cells.push(current);
      return cells;
    };

    return {
      steps: ["Upload", "Account", "Map", "Preview", "Confirm"],
      currentStep: 0,
      fileName: "",
      fileError: "",
      isSubmitting: false,
      importDone: false,
      uploadOpen: false,
      columns: [],
      mappings: {},
      rawRows: [],
      previewRows: [],
      accounts: JSON.parse(document.getElementById("import-accounts-data").textContent).map((acct) => ({
        id: acct.id,
        name: acct.name,
        type: acct.account_type,
      })),
      prefillAccountId: JSON.parse(document.getElementById("import-prefill-account").textContent),
      selectedAccount: "",
      init() {
        if (this.prefillAccountId) {
          this.selectedAccount = String(this.prefillAccountId);
          this.uploadOpen = true;
        }
      },
      resetWizard() {
        this.currentStep = 0;
        this.fileName = "";
        this.fileError = "";
        this.isSubmitting = false;
        this.importDone = false;
        this.columns = [];
        this.mappings = {};
        this.rawRows = [];
        this.previewRows = [];
        this.selectedAccount = this.prefillAccountId ? String(this.prefillAccountId) : "";
        const feedback = document.getElementById("import-feedback");
        if (feedback) feedback.innerHTML = "";
      },
      buildDefaultMap(columns) {
        const map = {};
        columns.forEach((col) => {
          map[col] = "ignore";
        });
        return map;
      },
      autoMap(columns) {
        const map = {};
        const byPriority = (patterns) => {
          for (const pattern of patterns) {
            const found = columns.find((col) => pattern.test(col.toLowerCase()));
            if (found) return found;
          }
          return null;
        };
        const dateCol = byPriority([/posting\s*date/, /transaction\s*date/, /date/]);
        const descCol = byPriority([/description/, /details/]);
        const amountCol = byPriority([/amount/]);
        if (dateCol) map[dateCol] = "date";
        if (descCol) map[descCol] = "description";
        if (amountCol) map[amountCol] = "amount";
        return map;
      },
      updatePreview() {
        const getMapped = (row, key) => {
          const column = Object.keys(this.mappings).find((col) => this.mappings[col] === key);
          return column ? row[column] || "" : "";
        };
        this.previewRows = this.rawRows.map((row, idx) => ({
          id: idx + 1,
          date: getMapped(row, "date"),
          description: getMapped(row, "description"),
          amount: getMapped(row, "amount"),
        }));
      },
      onFileSelect(event) {
        const file = event.target.files[0];
        this.fileName = file ? file.name : "";
        this.fileError = "";
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result || "";
          const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
          if (!lines.length) {
            this.fileError = "CSV file is empty.";
            return;
          }
          const headers = parseCSVLine(lines[0]).map((h) => h.trim()).filter((h) => h);
          if (!headers.length) {
            this.fileError = "CSV headers are missing.";
            return;
          }
          this.columns = headers;
          const defaults = this.buildDefaultMap(headers);
          this.mappings = { ...defaults, ...this.autoMap(headers) };
          this.rawRows = [];
          for (let i = 1; i < lines.length && this.rawRows.length < 10; i += 1) {
            const cells = parseCSVLine(lines[i]);
            if (cells.every((cell) => cell.trim() === "")) continue;
            const row = {};
            headers.forEach((header, idx) => {
              row[header] = (cells[idx] || "").trim();
            });
            this.rawRows.push(row);
          }
          this.updatePreview();
        };
        reader.readAsText(file);
      },
      mappingComplete() {
        const values = Object.values(this.mappings);
        const hasDate = values.filter((v) => v === "date").length === 1;
        const hasDesc = values.filter((v) => v === "description").length === 1;
        const hasAmount = values.filter((v) => v === "amount").length === 1;
        return hasDate && hasDesc && hasAmount;
      },
      canNext() {
        if (this.currentStep === 0) return !!this.fileName;
        if (this.currentStep === 1) return !!this.selectedAccount;
        if (this.currentStep === 2) return this.mappingComplete();
        return true;
      },
      canConfirm() {
        return !!this.selectedAccount && this.mappingComplete() && !!this.fileName;
      },
      nextStep() {
        if (this.canNext()) this.currentStep = Math.min(this.steps.length - 1, this.currentStep + 1);
      },
      prevStep() {
        this.currentStep = Math.max(0, this.currentStep - 1);
      },
    };
  }
</script>
{% endblock %}
