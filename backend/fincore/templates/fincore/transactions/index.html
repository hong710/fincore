{% extends "fincore/base.html" %}
{% block title %}Transactions · Fincore{% endblock %}

{% block content %}
<div
  class="space-y-4 flex flex-col h-full"
  x-data="{
    uploadOpen: false,
    editOpen: false,
    confirmOpen: false,
    transferMatchOpen: false,
    editForm: { id: null, date: '', vendor_id: '', description: '', category_id: '', kind: '', amount: '', is_imported: false, account_id: null, transfer_group_id: '', is_locked: false },
    openEdit(data) {
      this.editForm = { ...data };
      this.editOpen = true;
      this.confirmOpen = false;
      this.$nextTick(() => { if (this.$refs.editErrors) this.$refs.editErrors.textContent = ''; });
    },
    applyNewTransactionAccount(id) {
      const modalSelect = document.getElementById('new-transaction-account');
      if (modalSelect) modalSelect.value = id ? String(id) : '';
    },
    syncNewTransactionAccount() {
      const accountSelect = document.querySelector('#transactions-table select[name=account_id]');
      if (accountSelect) this.applyNewTransactionAccount(accountSelect.value);
    },
    openTransferMatch() {
      if (!this.editForm.id) return;
      this.transferMatchOpen = true;
      this.$nextTick(() => {
        const target = this.$refs.transferMatchList;
        if (!target) return;
        target.innerHTML = '';
        const loading = document.createElement('p');
        loading.className = 'text-xs text-slate-500';
        loading.textContent = 'Loading matches...';
        target.appendChild(loading);
        if (!window.htmx) return;
        const url = `{% url 'fincore:transaction_transfer_matches' %}?transaction_id=${this.editForm.id}`;
        window.htmx.ajax('GET', url, { target });
      });
    },
    refreshTransactions() {
      document.body.dispatchEvent(new CustomEvent('transactions:refresh'));
    },
    confirmDelete() {
      const url = '{% url 'fincore:transaction_delete' 0 %}'.replace('/0/', `/${this.editForm.id}/`);
      fetch(url, { method: 'POST', headers: { 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/) || [, ''])[1] } })
        .then(r => r.text())
        .then(html => {
          if (this.$refs.editErrors) this.$refs.editErrors.innerHTML = html;
          if (html.trim() === '') {
            this.confirmOpen = false;
            this.editOpen = false;
            this.refreshTransactions();
          }
        });
    }
  }"
  @open-import.window="uploadOpen = true"
  @transaction-edit.window="openEdit($event.detail)"
  @transactions:editClose.window="editOpen = false"
  @transactions:account-selected.window="applyNewTransactionAccount($event.detail && $event.detail.id)"
  @transactions:transferClose.window="transferMatchOpen = false"
>
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Transactions</h1>
      <p class="text-sm text-slate-500">View and manage transaction records</p>
    </div>
    <div class="flex items-center gap-2">
      <button class="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50" @click="$dispatch('open-import')">
        <svg class="h-4 w-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 10.5 21 6m0 0-4.5-4.5M21 6h-6a2.25 2.25 0 0 0-2.25 2.25V21M8.25 9.75H6.75A2.25 2.25 0 0 0 4.5 12v6a2.25 2.25 0 0 0 2.25 2.25h6a2.25 2.25 0 0 0 2.25-2.25v-1.5" /></svg>
        Upload .CSV
      </button>
      <button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700" data-hs-overlay="#new-transaction-modal" @click="syncNewTransactionAccount()">+ New Transaction</button>
    </div>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm flex flex-col flex-1 min-h-[calc(100vh-220px)]" id="transactions-table" hx-get="{% url 'fincore:transaction_table' %}{% if table_query %}?{{ table_query }}{% endif %}" hx-trigger="load"></div>

  <!-- Edit transaction modal -->
  <div
    x-cloak
    x-show="editOpen"
    class="fixed inset-0 z-[120] flex items-center justify-center overflow-y-auto bg-slate-900/40 p-4"
    role="dialog"
    aria-modal="true"
    @click.self="editOpen = false"
    @keydown.escape.window="editOpen = false"
  >
    <div x-transition.scale.origin.top class="w-full max-w-2xl rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">Edit Transaction</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" @click="editOpen = false" aria-label="Close">✕</button>
      </div>
      <div x-ref="editErrors" id="transaction-edit-errors" class="px-4 pt-3 text-sm text-rose-600"></div>
    <form
      class="space-y-4 p-4"
      hx-post="{% url 'fincore:transaction_update' %}"
      hx-target="#transaction-edit-errors"
      hx-swap="innerHTML"
      @htmx:after-request.camel="if ($event.detail.xhr.status === 204) { editOpen = false; refreshTransactions(); }"
    >
      <input type="hidden" name="transaction_id" x-model="editForm.id">
      <div class="grid gap-3 sm:grid-cols-2">
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Date</span>
          <input type="date" name="date" x-model="editForm.date" :disabled="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked" :class="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked ? 'bg-slate-100 text-slate-500' : 'bg-white'" class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
        </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Kind</span>
          <input type="text" x-model="editForm.kind" disabled class="w-full rounded-md border border-slate-200 bg-slate-100 px-3 py-2 text-sm text-slate-700">
          </label>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Category</span>
          <select
            name="category_id"
            x-model="editForm.category_id"
            :disabled="editForm.transfer_group_id || editForm.is_locked"
            class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
            hx-get="{% url 'fincore:category_options' %}"
            hx-trigger="categories:refresh from:body"
            hx-target="this"
            hx-swap="innerHTML"
            hx-vals="js:{selected_id: this.value}"
          >
            <option value="">Select category</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }} ({{ category.kind }})</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Amount</span>
          <input type="number" name="amount" step="0.01" x-model="editForm.amount" :disabled="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked" :class="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked ? 'bg-slate-100 text-slate-500' : 'bg-white'" class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
        </label>
      </div>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Vendor</span>
        <select name="vendor_id" x-model="editForm.vendor_id" :disabled="editForm.transfer_group_id || editForm.is_locked" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">Select vendor</option>
          {% for vendor in vendors %}
            <option value="{{ vendor.id }}">{{ vendor.name }} ({{ vendor.kind }})</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Description</span>
        <textarea rows="3" name="description" x-model="editForm.description" :disabled="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked" :class="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked ? 'bg-slate-100 text-slate-500' : 'bg-white'" class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional"></textarea>
      </label>
      <p class="text-xs text-amber-600" x-show="editForm.transfer_group_id || editForm.is_locked">
        Transfers are locked and must be corrected via reversal.
      </p>
        <div class="flex items-center justify-between gap-2">
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-md bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700 disabled:opacity-50 disabled:cursor-not-allowed"
            :disabled="editForm.is_imported || editForm.transfer_group_id || editForm.is_locked"
            @click="confirmOpen = true"
          >
            Delete
          </button>
          <div class="flex items-center gap-2">
            <button
              type="button"
              class="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
              :disabled="editForm.transfer_group_id || editForm.is_locked || editForm.kind === 'transfer'"
              @click="openTransferMatch()"
            >
              Mark as Transfer
            </button>
            <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" @click="editOpen = false">Cancel</button>
            <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" :disabled="editForm.transfer_group_id || editForm.is_locked">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Transfer match modal -->
  <div
    x-cloak
    x-show="transferMatchOpen"
    class="fixed inset-0 z-[125] flex items-center justify-center overflow-y-auto bg-slate-900/40 p-4"
    role="dialog"
    aria-modal="true"
    @click.self="transferMatchOpen = false"
    @keydown.escape.window="transferMatchOpen = false"
  >
    <div x-transition.scale.origin.top class="w-full max-w-2xl rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">Match Transfer</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" @click="transferMatchOpen = false" aria-label="Close">✕</button>
      </div>
      <div class="p-4">
        <div x-ref="transferMatchList"></div>
      </div>
    </div>
  </div>

  <div
    x-cloak
    x-show="confirmOpen"
    class="fixed inset-0 z-[130] flex items-center justify-center overflow-y-auto bg-slate-900/40 p-4"
    role="dialog"
    aria-modal="true"
    @click.self="confirmOpen = false"
    @keydown.escape.window="confirmOpen = false"
  >
    <div x-transition.scale.origin.top class="w-full max-w-md rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">Confirm Delete</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" @click="confirmOpen = false" aria-label="Close">✕</button>
      </div>
      <div class="p-4 text-sm text-slate-700">
        This will permanently delete the transaction. Continue?
      </div>
      <div class="flex items-center justify-end gap-2 border-t border-slate-200 p-4">
        <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" @click="confirmOpen = false">Cancel</button>
        <button type="button" class="inline-flex items-center gap-2 rounded-md bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700" @click="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>

<div id="new-transaction-modal" class="hs-overlay hidden fixed inset-0 z-50 overflow-y-auto" tabindex="-1">
  <div class="fixed inset-0 bg-slate-900/40"></div>
  <div class="relative flex min-h-full items-center justify-center p-4">
    <div class="w-full max-w-xl rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">New Transaction</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" data-hs-overlay="#new-transaction-modal" aria-label="Close">✕</button>
      </div>
      <form
        method="post"
        class="space-y-4 p-4"
        hx-post="{% url 'fincore:transaction_create' %}"
        hx-target="#new-transaction-errors"
        hx-swap="innerHTML"
        @htmx:after-request.camel="if ($event.detail.xhr.status === 204) { if (window.HSOverlay) window.HSOverlay.close('#new-transaction-modal'); }"
      >
        {% csrf_token %}
        <div id="new-transaction-errors" class="text-sm text-rose-600"></div>
        <div class="grid gap-3 sm:grid-cols-2">
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Date</span>
            <input type="date" name="date" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Account</span>
            <select id="new-transaction-account" name="account_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">Choose account</option>
              {% for acct in accounts %}
                <option value="{{ acct.id }}">{% if acct.parent_id %}• {% endif %}{{ acct.name }} ({{ acct.account_type }})</option>
              {% endfor %}
            </select>
          </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Category</span>
            <select
              name="category_id"
              class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
              hx-get="{% url 'fincore:category_options' %}"
              hx-trigger="categories:refresh from:body"
              hx-target="this"
              hx-swap="innerHTML"
              hx-vals="js:{selected_id: this.value}"
            >
              <option value="">Select category</option>
              {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }} ({{ category.kind }})</option>
              {% endfor %}
            </select>
          </label>
          <label class="space-y-1 text-xs font-medium text-slate-600">
            <span>Amount</span>
            <input type="number" name="amount" step="0.01" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00">
          </label>
        </div>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Vendor</span>
          <select name="vendor_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Select vendor</option>
            {% for vendor in vendors %}
              <option value="{{ vendor.id }}">{{ vendor.name }} ({{ vendor.kind }})</option>
            {% endfor %}
          </select>
        </label>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Description</span>
          <textarea name="description" rows="3" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional"></textarea>
        </label>
        <div class="flex items-center justify-end gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" data-hs-overlay="#new-transaction-modal">Cancel</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="bulk-action-modal" class="hs-overlay hidden fixed inset-0 z-50 overflow-y-auto" tabindex="-1">
  <div class="fixed inset-0 bg-slate-900/40"></div>
  <div class="relative flex min-h-full items-center justify-center p-4">
    <div class="w-full max-w-lg rounded-lg border border-slate-200 bg-white shadow-lg">
      <div class="flex items-center justify-between border-b border-slate-200 p-4">
        <h2 class="text-sm font-medium text-slate-700">Bulk Action</h2>
        <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" data-hs-overlay="#bulk-action-modal" aria-label="Close">✕</button>
      </div>
      <form
        class="space-y-4 p-4"
        hx-post="{% url 'fincore:transaction_bulk_action' %}"
        hx-target="#bulk-action-errors"
        hx-swap="innerHTML"
        @htmx:after-request.camel="if ($event.detail.xhr.status === 204) { if (window.HSOverlay) window.HSOverlay.close('#bulk-action-modal'); }"
        x-data="{ action: '' }"
      >
        <div id="bulk-action-errors" class="text-sm text-rose-600"></div>
        <label class="space-y-1 text-xs font-medium text-slate-600">
          <span>Action</span>
          <select name="action" x-model="action" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Select action</option>
            <option value="payee">Vendor</option>
            <option value="category">Category</option>
            <option value="delete">Delete</option>
          </select>
        </label>
        <label class="space-y-1 text-xs font-medium text-slate-600" x-show="action === 'payee'">
          <span>Vendor</span>
          <select name="vendor_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Select vendor</option>
            {% for vendor in vendors %}
              <option value="{{ vendor.id }}">{{ vendor.name }} ({{ vendor.kind }})</option>
            {% endfor %}
          </select>
          <a href="{% url 'fincore:vendor_list' %}" class="text-xs text-indigo-600 hover:text-indigo-700">Manage vendors</a>
        </label>
        <label class="space-y-1 text-xs font-medium text-slate-600" x-show="action === 'category'">
          <span>Category</span>
          <select name="category_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Select category</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }} ({{ category.kind }})</option>
            {% endfor %}
          </select>
          <a href="{% url 'fincore:category_list' %}" class="text-xs text-indigo-600 hover:text-indigo-700">Manage categories</a>
        </label>
        <p class="text-xs text-slate-500" x-show="action === 'delete'">Delete is allowed only for manually created transactions.</p>
        <div class="flex items-center justify-end gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50" data-hs-overlay="#bulk-action-modal">Cancel</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white">Apply</button>
        </div>
        <input type="hidden" name="transaction_ids" id="bulk-action-ids">
      </form>
    </div>
  </div>
</div>

<!-- Import CSV wizard modal -->
<div
  x-data="importWizard()"
  x-on:open-import.window="uploadOpen = true"
  x-on:import:staged.window="importDone = true"
  x-cloak
  x-show="uploadOpen"
  class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto bg-slate-900/40 p-4"
  role="dialog"
  aria-modal="true"
>
  <div x-transition.scale.origin.top class="w-full max-w-2xl rounded-lg border border-slate-200 bg-white shadow-lg">
    <div class="flex items-center justify-between border-b border-slate-200 p-4">
      <h2 class="text-sm font-medium text-slate-700">Upload CSV File</h2>
      <button class="rounded-md p-2 text-slate-500 hover:bg-slate-100" @click="uploadOpen = false; resetWizard()" aria-label="Close">✕</button>
    </div>
    <form
      class="space-y-0"
      enctype="multipart/form-data"
      hx-encoding="multipart/form-data"
      hx-post="{% url 'fincore:import_stage' %}"
      hx-target="#import-feedback"
      hx-swap="innerHTML"
      hx-on:htmx:beforeRequest="isSubmitting = true"
      hx-on:htmx:afterRequest="isSubmitting = false"
    >
      <div class="p-4 space-y-4">
        <div id="import-feedback" class="text-sm"></div>
        <input type="hidden" name="account_id" :value="selectedAccount">
        <input type="hidden" name="mapping" :value="JSON.stringify(mappings)">
        <input type="hidden" name="amount_strategy" :value="amountStrategy">
        <input type="hidden" name="indicator_credit_value" :value="indicatorCreditValue">
        <input type="hidden" name="indicator_debit_value" :value="indicatorDebitValue">
      <div class="flex items-center gap-2 text-xs font-semibold text-slate-600">
        <template x-for="(label, index) in steps" :key="index">
          <div class="flex items-center gap-2">
            <div class="flex h-6 w-6 items-center justify-center rounded-full border" :class="currentStep > index ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : currentStep === index ? 'border-indigo-500 text-indigo-700' : 'border-slate-200 text-slate-400'">
              <span x-text="index + 1"></span>
            </div>
            <span x-text="label"></span>
            <template x-if="index < steps.length - 1">
              <span class="text-slate-300">/</span>
            </template>
          </div>
        </template>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4" x-show="currentStep === 0">
        <h3 class="text-sm font-semibold text-slate-800">1) Upload CSV</h3>
        <p class="text-xs text-slate-500 mb-3">Accepted: .csv · Max 10MB.</p>
        <input type="file" name="csv_file" accept=".csv" class="block w-full cursor-pointer rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm file:mr-3 file:cursor-pointer file:rounded-md file:border-0 file:bg-indigo-600 file:px-4 file:py-2 file:text-sm file:font-medium file:text-white hover:file:bg-indigo-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
          @change="onFileSelect">
        <p class="mt-2 text-xs text-slate-600" x-text="fileName ? `Selected: ${fileName}` : 'No file selected'"></p>
        <p class="mt-2 text-xs text-rose-600" x-show="fileError" x-text="fileError"></p>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 1">
        <h3 class="text-sm font-semibold text-slate-800">2) Select account</h3>
        <p class="text-xs text-slate-500">Required. Account type guides validation (credit_card, debit_card, bank).</p>
        <select class="w-64 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model="selectedAccount">
          <option value="">Choose account</option>
          <template x-for="acct in accounts" :key="acct.id">
            <option :value="acct.id" x-text="`${acct.name} (${acct.type})`"></option>
          </template>
        </select>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 2">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-sm font-semibold text-slate-800">3) Column mapping</h3>
            <p class="text-xs text-slate-500">Map columns and select how amounts are represented in your CSV.</p>
          </div>
          <p class="text-xs font-semibold" :class="mappingComplete() ? 'text-emerald-600' : 'text-amber-600'" x-text="mappingComplete() ? 'Ready' : 'Incomplete'"></p>
        </div>

        <!-- Amount strategy radio -->
        <div class="space-y-2">
          <label class="block text-xs font-semibold text-slate-700">Amount format</label>
          <div class="flex flex-wrap gap-4">
            <label class="inline-flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
              <input type="radio" name="strategy_radio" value="signed" x-model="amountStrategy" @change="onStrategyChange()" class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-500">
              <span>Signed amount <span class="text-slate-400">(−44.22, +412.00)</span></span>
            </label>
            <label class="inline-flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
              <input type="radio" name="strategy_radio" value="indicator" x-model="amountStrategy" @change="onStrategyChange()" class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-500">
              <span>Amount + indicator <span class="text-slate-400">(1828.70, Credit)</span></span>
            </label>
            <label class="inline-flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
              <input type="radio" name="strategy_radio" value="split_columns" x-model="amountStrategy" @change="onStrategyChange()" class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-500">
              <span>Debit / Credit columns</span>
            </label>
          </div>
        </div>

        <!-- Indicator config (only for indicator strategy) -->
        <div x-show="amountStrategy === 'indicator'" x-cloak class="flex flex-wrap items-end gap-4 rounded-md border border-amber-200 bg-amber-50 p-3">
          <label class="space-y-1">
            <span class="block text-xs font-semibold text-slate-700">Credit value</span>
            <input type="text" class="w-32 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model="indicatorCreditValue" @input="updatePreview()" placeholder="Credit">
          </label>
          <label class="space-y-1">
            <span class="block text-xs font-semibold text-slate-700">Debit value</span>
            <input type="text" class="w-32 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model="indicatorDebitValue" @input="updatePreview()" placeholder="Debit">
          </label>
          <p class="text-xs text-amber-700">Enter the exact text values from your CSV that indicate Credit vs Debit.</p>
        </div>

        <!-- Column mapping table -->
        <div class="rounded border border-slate-200 bg-white max-h-[320px] overflow-auto">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-50 text-slate-600 sticky top-0 z-10">
              <tr>
                <th class="px-3 py-2 text-left">CSV Column</th>
                <th class="px-3 py-2 text-left">Map to</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="col in columns" :key="col">
                <tr class="hover:bg-slate-50">
                  <td class="px-3 py-2 font-medium text-slate-700 max-w-[200px] truncate" x-text="col" :title="col"></td>
                  <td class="px-3 py-2">
                    <select class="w-48 rounded-md bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
                      :class="mappings[col] !== 'ignore' ? 'border-indigo-500 ring-1 ring-indigo-200 font-semibold text-indigo-700' : 'border border-slate-200'"
                      x-model="mappings[col]" @change="updatePreview()">
                      <option value="ignore">Ignore</option>
                      <option value="date">Date</option>
                      <option value="description">Description</option>
                      <option value="amount" :disabled="amountStrategy === 'split_columns'" x-text="amountStrategy === 'indicator' ? 'Amount (unsigned)' : 'Amount (signed)'" x-show="amountStrategy !== 'split_columns'">Amount</option>
                      <option value="indicator" :disabled="amountStrategy !== 'indicator'" x-show="amountStrategy === 'indicator'">Credit/Debit Indicator</option>
                      <option value="debit" :disabled="amountStrategy !== 'split_columns'" x-show="amountStrategy === 'split_columns'">Debit</option>
                      <option value="credit" :disabled="amountStrategy !== 'split_columns'" x-show="amountStrategy === 'split_columns'">Credit</option>
                    </select>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-3" x-show="currentStep === 3">
        <h3 class="text-sm font-semibold text-slate-800">4) Preview (first 10 rows)</h3>
        <div class="overflow-auto rounded border border-slate-200 bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-3 py-2 text-left">Date</th>
                <th class="px-3 py-2 text-left">Description</th>
                <th class="px-3 py-2 text-right">Raw</th>
                <th class="px-3 py-2 text-right">Signed Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <template x-for="row in previewRows" :key="row.id">
                <tr class="hover:bg-slate-50">
                  <td class="px-3 py-2 text-slate-800" x-text="row.date"></td>
                  <td class="px-3 py-2 text-slate-800" x-text="row.description"></td>
                  <td class="px-3 py-2 text-right text-slate-500" x-text="row.rawDisplay"></td>
                  <td class="px-3 py-2 text-right font-semibold" :class="row.signedClass" x-text="row.signedDisplay"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="rounded-md border border-slate-200 bg-slate-50 p-4 space-y-2" x-show="currentStep === 4">
        <h3 class="text-sm font-semibold text-slate-800">5) Confirm import</h3>
        <ul class="list-disc pl-5 text-xs text-slate-700 space-y-1">
          <li>All rows will be marked imported and linked to one import batch.</li>
          <li>Amounts are normalised to a signed value: positive = income, negative = expense.</li>
          <li>Category and Payee will be empty; no auto-transfers or balances used.</li>
          <li>Rollback is only allowed per import batch (never partial).</li>
        </ul>
        <div class="mt-2 rounded-md border border-slate-200 bg-white p-3">
          <dl class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1 text-xs">
            <dt class="font-semibold text-slate-600">Strategy</dt>
            <dd class="text-slate-800" x-text="amountStrategy === 'signed' ? 'Signed Amount' : amountStrategy === 'indicator' ? 'Amount + Indicator' : 'Debit / Credit Columns'"></dd>
            <template x-if="amountStrategy === 'indicator'">
              <dt class="font-semibold text-slate-600">Credit value</dt>
            </template>
            <template x-if="amountStrategy === 'indicator'">
              <dd class="text-slate-800" x-text="indicatorCreditValue"></dd>
            </template>
            <template x-if="amountStrategy === 'indicator'">
              <dt class="font-semibold text-slate-600">Debit value</dt>
            </template>
            <template x-if="amountStrategy === 'indicator'">
              <dd class="text-slate-800" x-text="indicatorDebitValue"></dd>
            </template>
          </dl>
        </div>
      </div>
    </div>
      <div class="flex items-center justify-between border-t border-slate-200 p-4">
        <div class="flex items-center gap-2 text-xs text-slate-600" x-show="isSubmitting" x-cloak>
          <span class="h-3.5 w-3.5 animate-spin rounded-full border-2 border-slate-300 border-t-indigo-600"></span>
          <span>Uploading and validating...</span>
        </div>
        <button type="button" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50 disabled:opacity-60" :disabled="isSubmitting" @click="uploadOpen = false; resetWizard()">Cancel</button>
        <div class="flex items-center gap-2">
          <template x-if="currentStep < steps.length -1">
            <button type="button" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-60" :disabled="isSubmitting || !canNext()" @click="nextStep()">Next</button>
          </template>
          <template x-if="currentStep === steps.length -1">
            <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-60" :disabled="importDone || isSubmitting || !canConfirm()">Confirm import</button>
          </template>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block body_extra %}
{{ block.super }}
{{ accounts|json_script:"import-accounts-data" }}
{{ prefill_account_id|json_script:"import-prefill-account" }}
<script>
  function importWizard() {
    const parseCSVLine = (line) => {
      const cells = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === "," && !inQuotes) {
          cells.push(current);
          current = "";
        } else {
          current += char;
        }
      }
      cells.push(current);
      return cells;
    };

    const parseNum = (val) => {
      let s = (val || "").replace(/[$,]/g, "").trim();
      if (s.startsWith("(") && s.endsWith(")")) s = "-" + s.slice(1, -1);
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    };

    return {
      steps: ["Upload", "Account", "Map", "Preview", "Confirm"],
      currentStep: 0,
      fileName: "",
      fileError: "",
      isSubmitting: false,
      importDone: false,
      uploadOpen: false,
      columns: [],
      mappings: {},
      rawRows: [],
      previewRows: [],
      accounts: JSON.parse(document.getElementById("import-accounts-data").textContent).map((acct) => ({
        id: acct.id,
        name: acct.name,
        type: acct.account_type,
      })),
      prefillAccountId: JSON.parse(document.getElementById("import-prefill-account").textContent),
      selectedAccount: "",

      /* ── Amount strategy state ── */
      amountStrategy: "signed",
      indicatorCreditValue: "Credit",
      indicatorDebitValue: "Debit",

      init() {
        if (this.prefillAccountId) {
          this.selectedAccount = String(this.prefillAccountId);
          this.uploadOpen = true;
        }
      },
      resetWizard() {
        this.currentStep = 0;
        this.fileName = "";
        this.fileError = "";
        this.isSubmitting = false;
        this.importDone = false;
        this.columns = [];
        this.mappings = {};
        this.rawRows = [];
        this.previewRows = [];
        this.amountStrategy = "signed";
        this.indicatorCreditValue = "Credit";
        this.indicatorDebitValue = "Debit";
        this.selectedAccount = this.prefillAccountId ? String(this.prefillAccountId) : "";
        const feedback = document.getElementById("import-feedback");
        if (feedback) feedback.innerHTML = "";
      },

      /* ── Mapping options based on strategy ── */
      mappingOptions() {
        const base = [
          { value: "ignore", label: "Ignore" },
          { value: "date", label: "Date" },
          { value: "description", label: "Description" },
        ];
        if (this.amountStrategy === "signed") {
          base.push({ value: "amount", label: "Amount (signed)" });
        } else if (this.amountStrategy === "indicator") {
          base.push({ value: "amount", label: "Amount (unsigned)" });
          base.push({ value: "indicator", label: "Credit/Debit Indicator" });
        } else if (this.amountStrategy === "split_columns") {
          base.push({ value: "debit", label: "Debit" });
          base.push({ value: "credit", label: "Credit" });
        }
        return base;
      },

      /* ── Auto-detect strategy from CSV headers ── */
      autoDetectStrategy(columns) {
        const lower = columns.map((c) => c.toLowerCase().trim());
        if (lower.some((c) => /credit.*debit|debit.*credit/.test(c) && /indicator|type|flag/.test(c))) {
          return "indicator";
        }
        const hasDebitCol = lower.some((c) => /^debit$|^debit\s*amount$/.test(c));
        const hasCreditCol = lower.some((c) => /^credit$|^credit\s*amount$/.test(c));
        if (hasDebitCol && hasCreditCol) {
          return "split_columns";
        }
        return "signed";
      },

      /* ── When strategy changes, reset amount-related mappings ── */
      onStrategyChange() {
        const amountKeys = ["amount", "indicator", "debit", "credit"];
        for (const col of this.columns) {
          if (amountKeys.includes(this.mappings[col])) {
            this.mappings[col] = "ignore";
          }
        }
        const autoMapped = this.autoMap(this.columns);
        for (const [col, target] of Object.entries(autoMapped)) {
          if (amountKeys.includes(target)) {
            this.mappings[col] = target;
          }
        }
        this.updatePreview();
      },

      buildDefaultMap(columns) {
        const map = {};
        columns.forEach((col) => {
          map[col] = "ignore";
        });
        return map;
      },

      autoMap(columns) {
        const map = {};
        const byPriority = (patterns) => {
          for (const pattern of patterns) {
            const found = columns.find((col) => pattern.test(col.toLowerCase()));
            if (found) return found;
          }
          return null;
        };
        const dateCol = byPriority([/posting\s*date/, /transaction\s*date/, /date/]);
        const descCol = byPriority([/description/, /details/, /memo/]);
        if (dateCol) map[dateCol] = "date";
        if (descCol) map[descCol] = "description";

        if (this.amountStrategy === "signed") {
          const amountCol = byPriority([/amount/]);
          if (amountCol) map[amountCol] = "amount";
        } else if (this.amountStrategy === "indicator") {
          const amountCol = byPriority([/^amount$/]);
          if (amountCol) map[amountCol] = "amount";
          const indicatorCol = byPriority([/credit.*debit.*indicator/, /debit.*credit.*indicator/, /indicator/]);
          if (indicatorCol) map[indicatorCol] = "indicator";
        } else if (this.amountStrategy === "split_columns") {
          const debitCol = byPriority([/^debit$/, /^debit\s*amount$/]);
          const creditCol = byPriority([/^credit$/, /^credit\s*amount$/]);
          if (debitCol) map[debitCol] = "debit";
          if (creditCol) map[creditCol] = "credit";
        }
        return map;
      },

      /* ── Compute signed amount for one preview row ── */
      computeSignedAmount(row) {
        if (this.amountStrategy === "signed") {
          return parseNum(row.amount);
        } else if (this.amountStrategy === "indicator") {
          const amount = parseNum(row.amount);
          if (amount === null) return null;
          const ind = (row.indicator || "").trim().toLowerCase();
          const creditVal = this.indicatorCreditValue.trim().toLowerCase();
          const debitVal = this.indicatorDebitValue.trim().toLowerCase();
          if (creditVal && ind === creditVal) return Math.abs(amount);
          if (debitVal && ind === debitVal) return -Math.abs(amount);
          return null;
        } else if (this.amountStrategy === "split_columns") {
          const debit = row.debit ? parseNum(row.debit) : null;
          const credit = row.credit ? parseNum(row.credit) : null;
          if (debit !== null && credit !== null) return null;
          if (debit === null && credit === null) return null;
          if (debit !== null) return -Math.abs(debit);
          return Math.abs(credit);
        }
        return null;
      },

      updatePreview() {
        const getMapped = (row, key) => {
          const column = Object.keys(this.mappings).find((col) => this.mappings[col] === key);
          return column ? row[column] || "" : "";
        };
        this.previewRows = this.rawRows.map((row, idx) => {
          const pr = {
            id: idx + 1,
            date: getMapped(row, "date"),
            description: getMapped(row, "description"),
          };
          if (this.amountStrategy === "signed") {
            pr.amount = getMapped(row, "amount");
            pr.rawDisplay = pr.amount;
          } else if (this.amountStrategy === "indicator") {
            pr.amount = getMapped(row, "amount");
            pr.indicator = getMapped(row, "indicator");
            pr.rawDisplay = pr.amount + " (" + pr.indicator + ")";
          } else if (this.amountStrategy === "split_columns") {
            pr.debit = getMapped(row, "debit");
            pr.credit = getMapped(row, "credit");
            pr.rawDisplay = pr.debit ? "Dr " + pr.debit : "Cr " + pr.credit;
          }
          const signed = this.computeSignedAmount(pr);
          pr.signedAmount = signed;
          if (signed === null) {
            pr.signedDisplay = "ERR";
            pr.signedClass = "text-rose-600";
          } else if (signed >= 0) {
            pr.signedDisplay = "+" + signed.toFixed(2);
            pr.signedClass = "text-emerald-600";
          } else {
            pr.signedDisplay = signed.toFixed(2);
            pr.signedClass = "text-rose-600";
          }
          return pr;
        });
      },

      onFileSelect(event) {
        const file = event.target.files[0];
        this.fileName = file ? file.name : "";
        this.fileError = "";
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result || "";
          const lines = text.split(/\r?\n/).filter((line) => line.trim() !== "");
          if (!lines.length) {
            this.fileError = "CSV file is empty.";
            return;
          }
          const headers = parseCSVLine(lines[0]).map((h) => h.trim()).filter((h) => h);
          if (!headers.length) {
            this.fileError = "CSV headers are missing.";
            return;
          }
          this.columns = headers;
          this.amountStrategy = this.autoDetectStrategy(headers);
          if (this.amountStrategy === "indicator") {
            this.indicatorCreditValue = "Credit";
            this.indicatorDebitValue = "Debit";
          }
          const defaults = this.buildDefaultMap(headers);
          this.mappings = { ...defaults, ...this.autoMap(headers) };
          this.rawRows = [];
          for (let i = 1; i < lines.length && this.rawRows.length < 10; i += 1) {
            const cells = parseCSVLine(lines[i]);
            if (cells.every((cell) => cell.trim() === "")) continue;
            const row = {};
            headers.forEach((header, idx) => {
              row[header] = (cells[idx] || "").trim();
            });
            this.rawRows.push(row);
          }
          this.updatePreview();
        };
        reader.readAsText(file);
      },

      mappingComplete() {
        const values = Object.values(this.mappings);
        const hasDate = values.filter((v) => v === "date").length === 1;
        if (this.amountStrategy === "signed") {
          return hasDate && values.filter((v) => v === "amount").length === 1;
        } else if (this.amountStrategy === "indicator") {
          return hasDate
            && values.filter((v) => v === "amount").length === 1
            && values.filter((v) => v === "indicator").length === 1
            && this.indicatorCreditValue.trim() !== ""
            && this.indicatorDebitValue.trim() !== "";
        } else if (this.amountStrategy === "split_columns") {
          return hasDate
            && values.filter((v) => v === "debit").length === 1
            && values.filter((v) => v === "credit").length === 1;
        }
        return false;
      },

      canNext() {
        if (this.currentStep === 0) return !!this.fileName;
        if (this.currentStep === 1) return !!this.selectedAccount;
        if (this.currentStep === 2) return this.mappingComplete();
        return true;
      },
      canConfirm() {
        return !!this.selectedAccount && this.mappingComplete() && !!this.fileName;
      },
      nextStep() {
        if (this.canNext()) this.currentStep = Math.min(this.steps.length - 1, this.currentStep + 1);
      },
      prevStep() {
        this.currentStep = Math.max(0, this.currentStep - 1);
      },
    };
  }
</script>
{% endblock %}
