{% extends "fincore/base.html" %}
{% load humanize %}
{% block title %}Profit & Loss Â· Fincore{% endblock %}

{% block content %}
<div class="space-y-4 flex flex-col h-full">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Profit &amp; Loss</h1>
      <p class="text-sm text-slate-500">Summary across all accounts (income, COGS, and expenses).</p>
    </div>
  </div>

  <!-- Filter Form -->
  <form 
    class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm"
    id="pl-form"
  >
    <div class="flex flex-wrap items-end gap-4" x-data="{ range: '{{ filters.date_range }}' }">
      <!-- Report Period -->
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Report period</span>
        <select
          name="date_range"
          class="w-56 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
          x-model="range"
        >
          {% for value, label in report_ranges %}
            <option value="{{ value }}" {% if filters.date_range == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Custom Date Range (hidden by default) -->
      <label class="space-y-1 text-xs font-medium text-slate-600" x-show="range === 'custom'">
        <span>From</span>
        <input
          type="date"
          name="date_from"
          value="{{ filters.date_from }}"
          class="w-40 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
        >
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600" x-show="range === 'custom'">
        <span>To</span>
        <input
          type="date"
          name="date_to"
          value="{{ filters.date_to }}"
          class="w-40 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
        >
      </label>

      <!-- Account -->
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Account</span>
        <select
          name="account_id"
          class="w-56 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
        >
          <option value="" {% if filters.account_id == '' %}selected{% endif %}>All accounts</option>
          {% for account in accounts %}
            <option value="{{ account.id }}" {% if filters.account_id|stringformat:"s" == account.id|stringformat:"s" %}selected{% endif %}>{{ account.name }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Vendor -->
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Vendor</span>
        <select
          name="vendor_id"
          class="w-56 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
        >
          <option value="" {% if filters.vendor_id == '' %}selected{% endif %}>All vendors</option>
          {% for vendor in vendors %}
            <option value="{{ vendor.id }}" {% if filters.vendor_id|stringformat:"s" == vendor.id|stringformat:"s" %}selected{% endif %}>{{ vendor.name }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Category -->
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Category</span>
        <select
          name="category_id"
          class="w-56 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
        >
          <option value="" {% if filters.category_id == '' %}selected{% endif %}>All categories</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if filters.category_id|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }} ({{ category.kind }})</option>
          {% endfor %}
        </select>
      </label>

      <!-- Type -->
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Type</span>
        <select
          name="kind"
          class="w-40 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
        >
          <option value="all" {% if filters.kind == 'all' %}selected{% endif %}>All</option>
          <option value="income" {% if filters.kind == 'income' %}selected{% endif %}>Income</option>
          <option value="cogs" {% if filters.kind == 'cogs' %}selected{% endif %}>COGS</option>
          <option value="expense" {% if filters.kind == 'expense' %}selected{% endif %}>Expense</option>
        </select>
      </label>

      <!-- Apply Button -->
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700"
        onclick="submitFilters()"
      >
        Apply
      </button>

      <!-- Clear Button -->
      <a
        href="{% url 'fincore:profit_loss_report' %}"
        class="inline-flex items-center gap-2 rounded-md border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 cursor-pointer"
      >
        Clear Filters
      </a>
    </div>
  </form>

  <!-- Content Section (HTMX target) -->
  <div 
    id="pl-content" 
    class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm"
    hx-get="{% url 'fincore:profit_loss_content' %}"
    hx-trigger="load"
  >
    <!-- Loading state - will be replaced by HTMX -->
    <div class="flex items-center justify-center py-8">
      <p class="text-slate-500">Loading report...</p>
    </div>
  </div>
</div>

<script>
function submitFilters() {
  const form = document.getElementById('pl-form');
  const formData = new FormData(form);
  const params = new URLSearchParams(formData);
  params.set('apply', '1');
  
  const url = '{% url "fincore:profit_loss_content" %}?' + params.toString();
  
  htmx.ajax('GET', url, {
    target: '#pl-content',
    swap: 'innerHTML'
  });
}

// Load initial content on page load
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('pl-form');
  const formData = new FormData(form);
  const params = new URLSearchParams(formData);
  params.set('apply', '0');
  
  const url = '{% url "fincore:profit_loss_content" %}?' + params.toString();
  
  htmx.ajax('GET', url, {
    target: '#pl-content',
    swap: 'innerHTML'
  });
});
</script>
{% endblock %}
