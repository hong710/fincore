{% load formatting %}
<div class="pl-report-container flex flex-col h-full{% if is_single_period %} max-w-5xl mx-auto{% endif %}" x-data="{ openIncome: true, openCogs: true, openPayroll: true, openExpenses: true, openParents: {} }">
  <!-- Scrollable table area -->
  <div class="pl-report-scroll flex-1 overflow-auto min-h-0">
    <table class="{% if is_single_period %}table-auto{% else %}min-w-full table-fixed{% endif %} text-sm text-slate-800">
      <colgroup>
        {% if is_single_period %}
          <col class="w-auto">
          <col class="w-40">
        {% else %}
          <col class="w-64">
          {% for column in columns %}
            <col class="w-28">
          {% endfor %}
          <col class="w-28">
        {% endif %}
      </colgroup>
      <thead class="bg-slate-50 text-xs font-medium text-slate-700 border-b border-slate-200">
        <tr class="sticky top-0 bg-slate-50">
          <th class="py-2 px-4 text-left {% if is_single_period %}max-w-xl w-full{% endif %}">Category</th>
          {% if is_single_period %}
            <th class="py-2 px-4 text-right w-40">Amount</th>
          {% else %}
            {% for column in columns %}
              <th class="py-2 px-4 text-right">{{ column.label }}</th>
            {% endfor %}
            <th class="py-2 px-4 text-right">Total</th>
          {% endif %}
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
      {% if income_rows or cogs_rows or payroll_rows or expense_rows %}
        <tr class="bg-slate-50 text-sm font-semibold uppercase tracking-wide text-slate-700">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openIncome = !openIncome">
              <span class="text-slate-500" x-text="openIncome ? '▾' : '▸'"></span>
              <span>Income</span>
            </button>
          </td>
        </tr>
        {% if income_groups %}
          {% for group in income_groups %}
            <tr class="hover:bg-slate-50" x-show="openIncome">
              <td class="px-4 py-2 pl-6 text-sm text-slate-700">
                <div class="inline-flex items-center gap-2">
                  {% if group.has_children %}
                    <button type="button" class="inline-flex w-4 justify-center text-slate-500" @click="openParents['income-{{ group.parent_id }}'] = !openParents['income-{{ group.parent_id }}']" x-text="openParents['income-{{ group.parent_id }}'] ? '▾' : '▸'"></button>
                  {% else %}
                    <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                  {% endif %}
                  {% if group.has_children %}
                    <span class="text-slate-900 font-semibold">{{ group.parent_name }}</span>
                  {% else %}
                    <a class="text-slate-900 font-semibold hover:text-slate-900" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                      {{ group.parent_name }}
                    </a>
                  {% endif %}
                </div>
              </td>
              {% if is_single_period %}
                {% with cell=group.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40 font-semibold">
                    <span x-show="!openParents['income-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in group.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 font-semibold">
                    <span x-show="!openParents['income-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-emerald-600 font-semibold">{{ group.total|currency }}</td>
              {% endif %}
            </tr>
            {% if group.has_children %}
              {% for row in group.rows %}
                {% if row.category_id != group.parent_category_id %}
                  <tr class="hover:bg-slate-50" x-show="openIncome && openParents['income-{{ group.parent_id }}']">
                    <td class="px-4 py-2 pl-16 text-sm text-slate-700">
                      <div class="inline-flex items-center gap-2">
                        <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                          {{ row.name }}
                        </a>
                      </div>
                    </td>
                    {% if is_single_period %}
                      {% with cell=row.cells.0 %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endwith %}
                    {% else %}
                      {% for cell in row.cells %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endfor %}
                      <td class="px-4 py-2 text-right text-sm text-emerald-600">{{ row.total|currency }}</td>
                    {% endif %}
                  </tr>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% else %}
          <tr x-show="openIncome">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}
        <tr class="bg-slate-50 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Total Income</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right text-emerald-600 w-40">{{ income_total_display|currency }}</td>
          {% else %}
            {% for total in income_column_totals %}
              <td class="px-4 py-2 text-right text-emerald-600">{{ total|currency }}</td>
            {% endfor %}
            <td class="px-4 py-2 text-right text-emerald-600">{{ income_total_display|currency }}</td>
          {% endif %}
        </tr>

        <tr class="bg-slate-50 text-sm font-semibold uppercase tracking-wide text-slate-700">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openCogs = !openCogs">
              <span class="text-slate-500" x-text="openCogs ? '▾' : '▸'"></span>
              <span>COGS (Cost of Goods Sold)</span>
            </button>
          </td>
        </tr>
        {% if cogs_groups %}
          {% for group in cogs_groups %}
            <tr class="hover:bg-slate-50" x-show="openCogs">
              <td class="px-4 py-2 pl-6 text-sm text-slate-700">
                <div class="inline-flex items-center gap-2">
                  {% if group.has_children %}
                    <button type="button" class="inline-flex w-4 justify-center text-slate-500" @click="openParents['cogs-{{ group.parent_id }}'] = !openParents['cogs-{{ group.parent_id }}']" x-text="openParents['cogs-{{ group.parent_id }}'] ? '▾' : '▸'"></button>
                  {% else %}
                    <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                  {% endif %}
                  {% if group.has_children %}
                    <span class="text-slate-900 font-semibold">{{ group.parent_name }}</span>
                  {% else %}
                    <a class="text-slate-900 font-semibold hover:text-slate-900" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                      {{ group.parent_name }}
                    </a>
                  {% endif %}
                </div>
              </td>
              {% if is_single_period %}
                {% with cell=group.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40 font-semibold">
                    <span x-show="!openParents['cogs-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in group.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 font-semibold">
                    <span x-show="!openParents['cogs-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-rose-600 font-semibold">{{ group.total|currency }}</td>
              {% endif %}
            </tr>
            {% if group.has_children %}
              {% for row in group.rows %}
                {% if row.category_id != group.parent_category_id %}
                  <tr class="hover:bg-slate-50" x-show="openCogs && openParents['cogs-{{ group.parent_id }}']">
                    <td class="px-4 py-2 pl-16 text-sm text-slate-700">
                      <div class="inline-flex items-center gap-2">
                        <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                          {{ row.name }}
                        </a>
                      </div>
                    </td>
                    {% if is_single_period %}
                      {% with cell=row.cells.0 %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endwith %}
                    {% else %}
                      {% for cell in row.cells %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endfor %}
                      <td class="px-4 py-2 text-right text-sm text-rose-600">{{ row.total|currency }}</td>
                    {% endif %}
                  </tr>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% else %}
          <tr x-show="openCogs">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}
        <tr class="bg-slate-50 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Total COGS</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right text-rose-600 w-40">{{ cogs_total_display|currency }}</td>
          {% else %}
            {% for total in cogs_column_totals %}
              <td class="px-4 py-2 text-right text-rose-600">{{ total|currency }}</td>
            {% endfor %}
            <td class="px-4 py-2 text-right text-rose-600">{{ cogs_total_display|currency }}</td>
          {% endif %}
        </tr>

        <tr class="bg-slate-100 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Gross Profit</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right {% if gross_profit_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %} w-40">
              {{ gross_profit_display|currency }}
            </td>
          {% else %}
            {% for total in gross_profit_column_totals %}
              <td class="px-4 py-2 text-right {% if gross_profit_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
                {{ total|currency }}
              </td>
            {% endfor %}
            <td class="px-4 py-2 text-right {% if gross_profit_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
              {{ gross_profit_display|currency }}
            </td>
          {% endif %}
        </tr>

        <tr class="bg-slate-50 text-sm font-semibold uppercase tracking-wide text-slate-700">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openPayroll = !openPayroll">
              <span class="text-slate-500" x-text="openPayroll ? '▾' : '▸'"></span>
              <span>Payroll</span>
            </button>
          </td>
        </tr>
        {% if payroll_groups %}
          {% for group in payroll_groups %}
            <tr class="hover:bg-slate-50" x-show="openPayroll">
              <td class="px-4 py-2 pl-6 text-sm text-slate-700">
                <div class="inline-flex items-center gap-2">
                  {% if group.has_children %}
                    <button type="button" class="inline-flex w-4 justify-center text-slate-500" @click="openParents['payroll-{{ group.parent_id }}'] = !openParents['payroll-{{ group.parent_id }}']" x-text="openParents['payroll-{{ group.parent_id }}'] ? '▾' : '▸'"></button>
                  {% else %}
                    <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                  {% endif %}
                  {% if group.has_children %}
                    <span class="text-slate-900 font-semibold">{{ group.parent_name }}</span>
                  {% else %}
                    <a class="text-slate-900 font-semibold hover:text-slate-900" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                      {{ group.parent_name }}
                    </a>
                  {% endif %}
                </div>
              </td>
              {% if is_single_period %}
                {% with cell=group.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40 font-semibold">
                    <span x-show="!openParents['payroll-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in group.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 font-semibold">
                    <span x-show="!openParents['payroll-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-rose-600 font-semibold">{{ group.total|currency }}</td>
              {% endif %}
            </tr>
            {% if group.has_children %}
              {% for row in group.rows %}
                {% if row.category_id != group.parent_category_id %}
                  <tr class="hover:bg-slate-50" x-show="openPayroll && openParents['payroll-{{ group.parent_id }}']">
                    <td class="px-4 py-2 pl-16 text-sm text-slate-700">
                      <div class="inline-flex items-center gap-2">
                        <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                          {{ row.name }}
                        </a>
                      </div>
                    </td>
                    {% if is_single_period %}
                      {% with cell=row.cells.0 %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endwith %}
                    {% else %}
                      {% for cell in row.cells %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endfor %}
                      <td class="px-4 py-2 text-right text-sm text-rose-600">{{ row.total|currency }}</td>
                    {% endif %}
                  </tr>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% else %}
          <tr x-show="openPayroll">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}

        <tr class="bg-slate-50 text-sm font-semibold uppercase tracking-wide text-slate-700">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openExpenses = !openExpenses">
              <span class="text-slate-500" x-text="openExpenses ? '▾' : '▸'"></span>
              <span>Expenses</span>
            </button>
          </td>
        </tr>
        {% if expense_groups %}
          {% for group in expense_groups %}
            <tr class="hover:bg-slate-50" x-show="openExpenses">
              <td class="px-4 py-2 pl-6 text-sm text-slate-700">
                <div class="inline-flex items-center gap-2">
                  {% if group.has_children %}
                    <button type="button" class="inline-flex w-4 justify-center text-slate-500" @click="openParents['expense-{{ group.parent_id }}'] = !openParents['expense-{{ group.parent_id }}']" x-text="openParents['expense-{{ group.parent_id }}'] ? '▾' : '▸'"></button>
                  {% else %}
                    <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                  {% endif %}
                  {% if group.has_children %}
                    <span class="text-slate-900 font-semibold">{{ group.parent_name }}</span>
                  {% else %}
                    <a class="text-slate-900 font-semibold hover:text-slate-900" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                      {{ group.parent_name }}
                    </a>
                  {% endif %}
                </div>
              </td>
              {% if is_single_period %}
                {% with cell=group.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40 font-semibold">
                    <span x-show="!openParents['expense-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in group.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 font-semibold">
                    <span x-show="!openParents['expense-{{ group.parent_id }}']">
                      {% if cell.column.start %}
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' group.parent_category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                          {{ cell.value|currency }}
                        </a>
                      {% else %}
                        {{ cell.value|currency }}
                      {% endif %}
                    </span>
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-rose-600 font-semibold">{{ group.total|currency }}</td>
              {% endif %}
            </tr>
            {% if group.has_children %}
              {% for row in group.rows %}
                {% if row.category_id != group.parent_category_id %}
                  <tr class="hover:bg-slate-50" x-show="openExpenses && openParents['expense-{{ group.parent_id }}']">
                    <td class="px-4 py-2 pl-16 text-sm text-slate-700">
                      <div class="inline-flex items-center gap-2">
                        <span class="inline-flex w-4 justify-center text-slate-300">•</span>
                        <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                          {{ row.name }}
                        </a>
                      </div>
                    </td>
                    {% if is_single_period %}
                      {% with cell=row.cells.0 %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endwith %}
                    {% else %}
                      {% for cell in row.cells %}
                        <td class="px-4 py-2 text-right text-sm text-slate-700">
                          {% if cell.column.start %}
                            <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                              {{ cell.value|currency }}
                            </a>
                          {% else %}
                            {{ cell.value|currency }}
                          {% endif %}
                        </td>
                      {% endfor %}
                      <td class="px-4 py-2 text-right text-sm text-rose-600">{{ row.total|currency }}</td>
                    {% endif %}
                  </tr>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% else %}
          <tr x-show="openExpenses">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}
        <tr class="bg-slate-50 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Total Expenses</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right text-rose-600 w-40">{{ expense_total_display|currency }}</td>
          {% else %}
            {% for total in expense_column_totals %}
              <td class="px-4 py-2 text-right text-rose-600">{{ total|currency }}</td>
            {% endfor %}
            <td class="px-4 py-2 text-right text-rose-600">{{ expense_total_display|currency }}</td>
          {% endif %}
        </tr>

        <tr class="bg-slate-100 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Net Operating Income</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right {% if net_operating_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %} w-40">
              {{ net_operating_income_display|currency }}
            </td>
          {% else %}
            {% for total in net_operating_income_column_totals %}
              <td class="px-4 py-2 text-right {% if net_operating_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
                {{ total|currency }}
              </td>
            {% endfor %}
            <td class="px-4 py-2 text-right {% if net_operating_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
              {{ net_operating_income_display|currency }}
            </td>
          {% endif %}
        </tr>

      {% else %}
        <tr>
          <td colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}" class="px-4 py-6 text-center text-sm text-slate-500">No profit &amp; loss data for the selected filters.</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
  <!-- Fixed Net Income footer -->
  <div class="pl-report-footer flex-shrink-0 border-t border-slate-300 bg-indigo-50">
    <table class="{% if is_single_period %}table-auto{% else %}min-w-full table-fixed{% endif %} text-sm">
      <colgroup>
        {% if is_single_period %}
          <col class="w-auto">
          <col class="w-40">
        {% else %}
          <col class="w-64">
          {% for column in columns %}
            <col class="w-28">
          {% endfor %}
          <col class="w-28">
        {% endif %}
      </colgroup>
      <tr class="text-sm font-semibold text-slate-900">
        <td class="px-4 py-3">Net Income</td>
        {% if is_single_period %}
          <td class="px-4 py-3 text-right {% if net_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %} w-40">
            {{ net_income_display|currency }}
          </td>
        {% else %}
          {% for total in net_income_column_totals %}
            <td class="px-4 py-2 text-right {% if net_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
              {{ total|currency }}
            </td>
          {% endfor %}
          <td class="px-4 py-3 text-right {% if net_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
            {{ net_income_display|currency }}
          </td>
        {% endif %}
      </tr>
    </table>
  </div>
</div>
