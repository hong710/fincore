{% load formatting %}
<div class="overflow-auto{% if is_single_period %} max-w-5xl mx-auto{% endif %}" x-data="{ openIncome: true, openCogs: true, openExpenses: true, openOtherIncome: true, openOtherExpenses: true }">
  <table class="{% if is_single_period %}table-auto{% else %}min-w-full{% endif %} text-sm text-slate-800">
    <thead class="bg-slate-50 text-xs font-medium text-slate-700 border-b border-slate-200">
      <tr class="sticky top-0 bg-slate-50">
        <th class="py-2 px-4 text-left {% if is_single_period %}max-w-xl w-full{% endif %}">Category</th>
        {% if is_single_period %}
          <th class="py-2 px-4 text-right w-40">Amount</th>
        {% else %}
          {% for column in columns %}
            <th class="py-2 px-4 text-right">{{ column.label }}</th>
          {% endfor %}
          <th class="py-2 px-4 text-right">Total</th>
        {% endif %}
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-200">
      {% if income_rows or cogs_rows or expense_rows %}
        <tr class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openIncome = !openIncome">
              <span class="text-slate-500" x-text="openIncome ? '▾' : '▸'"></span>
              <span>Income</span>
            </button>
          </td>
        </tr>
        {% if income_rows %}
          {% for row in income_rows %}
            <tr class="hover:bg-slate-50" x-show="openIncome">
              <td class="px-4 py-2 pl-8 text-sm text-slate-700">
                <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                  {{ row.name }}
                </a>
              </td>
              {% if is_single_period %}
                {% with cell=row.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                    {% if cell.column.start %}
                      <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                        {{ cell.value|currency }}
                      </a>
                    {% else %}
                      {{ cell.value|currency }}
                    {% endif %}
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in row.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700">
                    {% if cell.column.start %}
                      <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                        {{ cell.value|currency }}
                      </a>
                    {% else %}
                      {{ cell.value|currency }}
                    {% endif %}
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-emerald-600">{{ row.total|currency }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        {% else %}
          <tr x-show="openIncome">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}
        <tr class="bg-slate-50 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Total Income</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right text-emerald-600 w-40">{{ income_total_display|currency }}</td>
          {% else %}
            {% for total in income_column_totals %}
              <td class="px-4 py-2 text-right text-emerald-600">{{ total|currency }}</td>
            {% endfor %}
            <td class="px-4 py-2 text-right text-emerald-600">{{ income_total_display|currency }}</td>
          {% endif %}
        </tr>

        <tr class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openCogs = !openCogs">
              <span class="text-slate-500" x-text="openCogs ? '▾' : '▸'"></span>
              <span>COGS (Cost of Goods Sold)</span>
            </button>
          </td>
        </tr>
        {% if cogs_rows %}
          {% for row in cogs_rows %}
            <tr class="hover:bg-slate-50" x-show="openCogs">
              <td class="px-4 py-2 pl-8 text-sm text-slate-700">
                <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                  {{ row.name }}
                </a>
              </td>
              {% if is_single_period %}
                {% with cell=row.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                    {% if cell.column.start %}
                      <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                        {{ cell.value|currency }}
                      </a>
                    {% else %}
                      {{ cell.value|currency }}
                    {% endif %}
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in row.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700">
                    {% if cell.column.start %}
                      <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                        {{ cell.value|currency }}
                      </a>
                    {% else %}
                      {{ cell.value|currency }}
                    {% endif %}
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-rose-600">{{ row.total|currency }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        {% else %}
          <tr x-show="openCogs">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}
        <tr class="bg-slate-50 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Total COGS</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right text-rose-600 w-40">{{ cogs_total_display|currency }}</td>
          {% else %}
            {% for total in cogs_column_totals %}
              <td class="px-4 py-2 text-right text-rose-600">{{ total|currency }}</td>
            {% endfor %}
            <td class="px-4 py-2 text-right text-rose-600">{{ cogs_total_display|currency }}</td>
          {% endif %}
        </tr>

        <tr class="bg-slate-100 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Gross Profit</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right {% if gross_profit_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %} w-40">
              {{ gross_profit_display|currency }}
            </td>
          {% else %}
            {% for total in gross_profit_column_totals %}
              <td class="px-4 py-2 text-right {% if gross_profit_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
                {{ total|currency }}
              </td>
            {% endfor %}
            <td class="px-4 py-2 text-right {% if gross_profit_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
              {{ gross_profit_display|currency }}
            </td>
          {% endif %}
        </tr>

        <tr class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openExpenses = !openExpenses">
              <span class="text-slate-500" x-text="openExpenses ? '▾' : '▸'"></span>
              <span>Expenses</span>
            </button>
          </td>
        </tr>
        {% if expense_rows %}
          {% for row in expense_rows %}
            <tr class="hover:bg-slate-50" x-show="openExpenses">
              <td class="px-4 py-2 pl-8 text-sm text-slate-700">
                <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range={{ filters.date_range }}{% if filters.date_range == 'custom' and filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_range == 'custom' and filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">
                  {{ row.name }}
                </a>
              </td>
              {% if is_single_period %}
                {% with cell=row.cells.0 %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700 w-40">
                    {% if cell.column.start %}
                      <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                        {{ cell.value|currency }}
                      </a>
                    {% else %}
                      {{ cell.value|currency }}
                    {% endif %}
                  </td>
                {% endwith %}
              {% else %}
                {% for cell in row.cells %}
                  <td class="px-4 py-2 text-right text-sm text-slate-700">
                    {% if cell.column.start %}
                      <a class="text-indigo-600 hover:text-indigo-700" href="{% url 'fincore:category_report' row.category_id %}?date_range=custom&date_from={{ cell.column.start|date:'Y-m-d' }}&date_to={{ cell.column.end|date:'Y-m-d' }}">
                        {{ cell.value|currency }}
                      </a>
                    {% else %}
                      {{ cell.value|currency }}
                    {% endif %}
                  </td>
                {% endfor %}
                <td class="px-4 py-2 text-right text-sm text-rose-600">{{ row.total|currency }}</td>
              {% endif %}
            </tr>
          {% endfor %}
        {% else %}
          <tr x-show="openExpenses">
            <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
          </tr>
        {% endif %}
        <tr class="bg-slate-50 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Total Expenses</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right text-rose-600 w-40">{{ expense_total_display|currency }}</td>
          {% else %}
            {% for total in expense_column_totals %}
              <td class="px-4 py-2 text-right text-rose-600">{{ total|currency }}</td>
            {% endfor %}
            <td class="px-4 py-2 text-right text-rose-600">{{ expense_total_display|currency }}</td>
          {% endif %}
        </tr>

        <tr class="bg-slate-100 text-sm font-semibold text-slate-700">
          <td class="px-4 py-2">Net Operating Income</td>
          {% if is_single_period %}
            <td class="px-4 py-2 text-right {% if net_operating_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %} w-40">
              {{ net_operating_income_display|currency }}
            </td>
          {% else %}
            {% for total in net_operating_income_column_totals %}
              <td class="px-4 py-2 text-right {% if net_operating_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
                {{ total|currency }}
              </td>
            {% endfor %}
            <td class="px-4 py-2 text-right {% if net_operating_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
              {{ net_operating_income_display|currency }}
            </td>
          {% endif %}
        </tr>

        <tr class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openOtherIncome = !openOtherIncome">
              <span class="text-slate-500" x-text="openOtherIncome ? '▾' : '▸'"></span>
              <span>Other Income</span>
            </button>
          </td>
        </tr>
        <tr x-show="openOtherIncome">
          <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
        </tr>

        <tr class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-600">
          <td class="px-4 py-2" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">
            <button type="button" class="inline-flex items-center gap-2" @click="openOtherExpenses = !openOtherExpenses">
              <span class="text-slate-500" x-text="openOtherExpenses ? '▾' : '▸'"></span>
              <span>Other Expenses</span>
            </button>
          </td>
        </tr>
        <tr x-show="openOtherExpenses">
          <td class="px-4 py-3 text-sm text-slate-500" colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}">—</td>
        </tr>

        <tr class="bg-indigo-50 text-sm font-semibold text-slate-900">
          <td class="px-4 py-3">Net Income</td>
          {% if is_single_period %}
            <td class="px-4 py-3 text-right {% if net_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %} w-40">
              {{ net_income_display|currency }}
            </td>
          {% else %}
            {% for total in net_income_column_totals %}
              <td class="px-4 py-2 text-right {% if net_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
                {{ total|currency }}
              </td>
            {% endfor %}
            <td class="px-4 py-3 text-right {% if net_income_is_negative %}text-rose-600{% else %}text-emerald-600{% endif %}">
              {{ net_income_display|currency }}
            </td>
          {% endif %}
        </tr>
      {% else %}
        <tr>
          <td colspan="{% if is_single_period %}2{% else %}{{ columns|length|add:'2' }}{% endif %}" class="px-4 py-6 text-center text-sm text-slate-500">No profit &amp; loss data for the selected filters.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
