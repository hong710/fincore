{{ filter_payload|json_script:"txn-filter-payload" }}
{{ payee_options|json_script:"txn-payee-options" }}
{{ description_options|json_script:"txn-description-options" }}
{{ kind_options|json_script:"txn-kind-options" }}
{{ category_options|json_script:"txn-category-options" }}

<div
  class="flex h-full flex-col space-y-4"
  x-data="{
    payload: (() => {
      const el = document.getElementById('txn-filter-payload');
      if (!el) return {};
      try {
        return JSON.parse(el.textContent);
      } catch (err) {
        return {};
      }
    })(),
    payeeOptions: [],
    descriptionOptions: [],
    kindOptions: [],
    categoryOptions: [],
    selectedIds: [],
    accountId: null,
    page: 1,
    pageSize: 25,
    search: '',
    sortField: '',
    sortDir: 'asc',
    payeeSearch: '',
    descriptionSearch: '',
    kindSearch: '',
    categorySearch: '',
    searchHadFocus: false,
    filters: {
      date: { range: { type: 'all', key: '', from: '', to: '' } },
      payee: { selected: [] },
      description: { selected: [] },
      kind: { selected: [] },
      category: { selected: [] },
      amount: { type: 'all', min: '', max: '' }
    },
    draft: {
      dateRange: { type: 'all', key: '', from: '', to: '' },
      payee: [],
      description: [],
      kind: [],
      category: [],
      amount: { type: 'all', min: '', max: '' }
    },
    init() {
      this.loadOptions();
      this.selectedIds = this.loadSelection();
      this.$watch('selectedIds', () => this.saveSelection());
      this.page = this.payload.page || 1;
      this.pageSize = this.payload.page_size || 25;
      this.accountId = this.payload.account_id || null;
      this.$nextTick(() => {
        this.$dispatch('transactions:account-selected', { id: this.accountId });
      });
      this.search = this.payload.search || '';
      this.sortField = this.payload.sort || '';
      this.sortDir = this.payload.dir || 'asc';

      const range = this.payload.date_range || 'all';
      if (range === 'custom') {
        this.filters.date.range = { type: 'custom', key: '', from: this.payload.date_from || '', to: this.payload.date_to || '' };
      } else if (range !== 'all') {
        this.filters.date.range = { type: 'quick', key: range, from: '', to: '' };
      }

      const ensureArray = (value) => Array.isArray(value) ? value : [];
      this.filters.payee.selected = ensureArray(this.payload.payee);
      this.filters.description.selected = ensureArray(this.payload.description);
      this.filters.kind.selected = ensureArray(this.payload.kind);
      this.filters.category.selected = ensureArray(this.payload.category);
      this.filters.amount = {
        type: this.payload.amount_type || 'all',
        min: this.payload.amount_min || '',
        max: this.payload.amount_max || ''
      };
      this.resetDraftAll();
    },
    loadOptions() {
      const readJson = (id) => {
        const el = document.getElementById(id);
        if (!el) return [];
        try {
          return JSON.parse(el.textContent);
        } catch (err) {
          return [];
        }
      };
      this.payeeOptions = readJson('txn-payee-options');
      this.descriptionOptions = readJson('txn-description-options');
      this.kindOptions = readJson('txn-kind-options');
      this.categoryOptions = readJson('txn-category-options');
    },
    loadSelection() {
      try {
        const stored = window.sessionStorage.getItem('txn-selected-ids');
        const parsed = stored ? JSON.parse(stored) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        return [];
      }
    },
    saveSelection() {
      try {
        window.sessionStorage.setItem('txn-selected-ids', JSON.stringify(this.selectedIds || []));
      } catch (err) {
        // Ignore storage failures (private mode, quota, etc).
      }
    },
    rememberSearchFocus() {
      const active = document.activeElement;
      this.searchHadFocus = !!active && active.id === 'txn-search';
    },
    restoreSearchFocus() {
      if (!this.searchHadFocus) return;
      const input = document.getElementById('txn-search');
      if (!input) return;
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
      this.searchHadFocus = false;
    },
    resetDraftAll() {
      this.draft.dateRange = { ...this.filters.date.range };
      this.draft.payee = [...this.filters.payee.selected];
      this.draft.description = [...this.filters.description.selected];
      this.draft.kind = [...this.filters.kind.selected];
      this.draft.category = [...this.filters.category.selected];
      this.draft.amount = { ...this.filters.amount };
    },
    selectQuickRange(key) {
      this.draft.dateRange = { type: 'quick', key, from: '', to: '' };
    },
    applyDraft(type) {
      if (type === 'date') this.filters.date.range = { ...this.draft.dateRange };
      if (type === 'payee') this.filters.payee.selected = [...this.draft.payee];
      if (type === 'description') this.filters.description.selected = [...this.draft.description];
      if (type === 'kind') this.filters.kind.selected = [...this.draft.kind];
      if (type === 'category') this.filters.category.selected = [...this.draft.category];
      if (type === 'amount') this.filters.amount = { ...this.draft.amount };
      this.submitFilters();
    },
    resetDraft(type) {
      if (type === 'date') this.draft.dateRange = { ...this.filters.date.range };
      if (type === 'payee') this.draft.payee = [...this.filters.payee.selected];
      if (type === 'description') this.draft.description = [...this.filters.description.selected];
      if (type === 'kind') this.draft.kind = [...this.filters.kind.selected];
      if (type === 'category') this.draft.category = [...this.filters.category.selected];
      if (type === 'amount') this.draft.amount = { ...this.filters.amount };
    },
    clearFilter(type) {
      if (type === 'date') this.filters.date.range = { type: 'all', key: '', from: '', to: '' };
      if (type === 'payee') this.filters.payee.selected = [];
      if (type === 'description') this.filters.description.selected = [];
      if (type === 'kind') this.filters.kind.selected = [];
      if (type === 'category') this.filters.category.selected = [];
      if (type === 'amount') this.filters.amount = { type: 'all', min: '', max: '' };
      this.resetDraft(type);
      this.submitFilters();
    },
    filterActive(type) {
      if (type === 'date') return this.filters.date.range.type !== 'all';
      if (type === 'payee') return this.filters.payee.selected.length > 0;
      if (type === 'description') return this.filters.description.selected.length > 0;
      if (type === 'kind') return this.filters.kind.selected.length > 0;
      if (type === 'category') return this.filters.category.selected.length > 0;
      if (type === 'amount') return this.filters.amount.type !== 'all' || this.filters.amount.min !== '' || this.filters.amount.max !== '';
      return false;
    },
    selectAll(type) {
      if (type === 'payee') this.draft.payee = [...this.payeeOptions];
      if (type === 'description') this.draft.description = [...this.descriptionOptions];
      if (type === 'kind') this.draft.kind = [...this.kindOptions];
      if (type === 'category') this.draft.category = this.categoryOptions.map((opt) => String(opt.category_id));
    },
    unselectAll(type) {
      if (type === 'payee') this.draft.payee = [];
      if (type === 'description') this.draft.description = [];
      if (type === 'kind') this.draft.kind = [];
      if (type === 'category') this.draft.category = [];
    },
    filteredCategoryOptions() {
      const search = this.categorySearch.toLowerCase();
      return this.categoryOptions.filter((opt) => String(opt.category__name).toLowerCase().includes(search));
    },
    filteredOptions(type) {
      const search = (type === 'payee' ? this.payeeSearch : type === 'description' ? this.descriptionSearch : this.kindSearch).toLowerCase();
      const options = type === 'payee' ? this.payeeOptions : type === 'description' ? this.descriptionOptions : this.kindOptions;
      return options.filter((opt) => String(opt).toLowerCase().includes(search));
    },
    setSort(field, dir) {
      this.sortField = field;
      this.sortDir = dir;
      this.submitFilters();
    },
    dateRangeValue() {
      return this.filters.date.range.type === 'all' ? 'all' : (this.filters.date.range.type === 'custom' ? 'custom' : this.filters.date.range.key);
    },
    submitFilters() {
      this.page = 1;
      this.$nextTick(() => {
        const form = this.$refs.filterForm;
        if (!form) return;
        form.querySelectorAll('input[type=hidden]').forEach(input => {
          const name = input.name;
          if (name === 'page') input.value = this.page;
          else if (name === 'date_range') input.value = this.dateRangeValue();
          else if (name === 'date_from') input.value = this.filters.date.range.from;
          else if (name === 'date_to') input.value = this.filters.date.range.to;
          else if (name === 'amount_type') input.value = this.filters.amount.type;
          else if (name === 'amount_min') input.value = this.filters.amount.min;
          else if (name === 'amount_max') input.value = this.filters.amount.max;
          else if (name === 'sort') input.value = this.sortField;
          else if (name === 'dir') input.value = this.sortDir;
        });
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else if (window.htmx) {
          window.htmx.trigger(form, 'submit');
        } else {
          form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      });
    },
    refreshCurrent() {
      this.$nextTick(() => {
        const form = this.$refs.filterForm;
        if (!form) return;
        const accountSelect = form.querySelector('select[name=account_id]');
        if (accountSelect && this.accountId !== null) {
          accountSelect.value = String(this.accountId);
        }
        form.querySelectorAll('input[type=hidden]').forEach(input => {
          const name = input.name;
          if (name === 'page') input.value = this.page;
          else if (name === 'date_range') input.value = this.dateRangeValue();
          else if (name === 'date_from') input.value = this.filters.date.range.from;
          else if (name === 'date_to') input.value = this.filters.date.range.to;
          else if (name === 'amount_type') input.value = this.filters.amount.type;
          else if (name === 'amount_min') input.value = this.filters.amount.min;
          else if (name === 'amount_max') input.value = this.filters.amount.max;
          else if (name === 'sort') input.value = this.sortField;
          else if (name === 'dir') input.value = this.sortDir;
        });
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else if (window.htmx) {
          window.htmx.trigger(form, 'submit');
        } else {
          form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      });
    },
    resetAllFilters() {
      this.search = '';
      this.sortField = '';
      this.sortDir = 'asc';
      this.selectedIds = [];
      this.saveSelection();
      this.filters = {
        date: { range: { type: 'all', key: '', from: '', to: '' } },
        payee: { selected: [] },
        description: { selected: [] },
        kind: { selected: [] },
        category: { selected: [] },
        amount: { type: 'all', min: '', max: '' }
      };
      this.resetDraftAll();
      this.submitFilters();
    },
    openBulkAction() {
      const input = document.getElementById('bulk-action-ids');
      if (input) {
        input.value = this.selectedIds.join(',');
      }
      if (window.HSOverlay) {
        window.HSOverlay.open('#bulk-action-modal');
      }
    }
  }"
  @htmx:before-request.window="rememberSearchFocus()"
  @htmx:after-swap.window="loadOptions(); selectedIds = loadSelection(); restoreSearchFocus()"
  @transactions:refresh.window="refreshCurrent()"
>
  {% include "fincore/components/filter_table_shell.html" with header_template="fincore/transactions/table_header.html" table_template="fincore/transactions/table_table.html" %}
</div>
