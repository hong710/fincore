{% load humanize %}
<div class="space-y-3" x-data="matchManager({{ bill.id }}, {{ remaining_balance }})">
  <div class="text-xs text-slate-600">
    Bill {{ bill.number }} total {{ bill.total|floatformat:2|intcomma }} ·
    <span class="font-semibold">Remaining <span x-text="formatMoney(remaining)"></span></span>
  </div>

  {% if form_errors %}
    <div class="rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700">
      <ul class="list-disc pl-4">
        {% for error in form_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form
    hx-post="{% url 'fincore:bill_match_apply' %}"
    hx-target="closest .space-y-3"
    hx-swap="outerHTML"
    @submit="if (!validateMatches()) $event.preventDefault()"
  >
    {% csrf_token %}
    <input type="hidden" name="bill_id" value="{{ bill.id }}">

    {% if best_matches %}
      <div class="space-y-2">
        <h3 class="text-xs font-semibold text-slate-700">
          Best Matches <span class="font-normal text-slate-500">(can cover remaining balance)</span>
        </h3>
        <div class="overflow-hidden rounded-md border border-indigo-200">
          <table class="min-w-full text-xs text-slate-700">
            <thead class="bg-indigo-50 text-slate-600">
              <tr>
                <th class="px-3 py-2 text-center w-12">Select</th>
                <th class="px-3 py-2 text-left">Date</th>
                <th class="px-3 py-2 text-left">Vendor</th>
                <th class="px-3 py-2 text-left">Description</th>
                <th class="px-3 py-2 text-right">Amount</th>
                <th class="px-3 py-2 text-right">Match Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
              {% for txn in best_matches %}
                <tr class="hover:bg-slate-50" :class="{ 'bg-indigo-50': selected.has({{ txn.id }}) }">
                  <td class="px-3 py-2 text-center">
                    <input
                      type="checkbox"
                      class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                      @change="toggleTransaction({{ txn.id }}, {{ txn.abs_amount }})"
                      :checked="selected.has({{ txn.id }})"
                    >
                  </td>
                  <td class="px-3 py-2">{{ txn.date|date:"M j, Y" }}</td>
                  <td class="px-3 py-2">{{ txn.vendor.name|default:"-" }}</td>
                  <td class="px-3 py-2 text-slate-600">{{ txn.description|truncatewords:8 }}</td>
                  <td class="px-3 py-2 text-right">{{ txn.abs_amount|floatformat:2|intcomma }}</td>
                  <td class="px-3 py-2 text-right">
                    <input
                      type="number"
                      step="0.01"
                      name="match_txn_{{ txn.id }}"
                      x-model.number="amounts[{{ txn.id }}]"
                      :disabled="!selected.has({{ txn.id }})"
                      class="w-24 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500 disabled:bg-slate-100"
                      @input="updateTotal()"
                    >
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {% if other_transactions %}
      <div class="space-y-2">
        <h3 class="text-xs font-semibold text-slate-700">
          All Other Transactions <span class="font-normal text-slate-500">(within ±30 days, same account)</span>
        </h3>
        <div class="overflow-hidden rounded-md border border-slate-200">
          <div class="max-h-[320px] overflow-auto">
            <table class="min-w-full text-xs text-slate-700">
              <thead class="bg-slate-50 text-slate-600 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-center w-12">Select</th>
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">Vendor</th>
                  <th class="px-3 py-2 text-left">Description</th>
                  <th class="px-3 py-2 text-right">Amount</th>
                  <th class="px-3 py-2 text-right">Match Amount</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                {% for txn in other_transactions %}
                  <tr class="hover:bg-slate-50" :class="{ 'bg-indigo-50': selected.has({{ txn.id }}) }">
                    <td class="px-3 py-2 text-center">
                      <input
                        type="checkbox"
                        class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                        @change="toggleTransaction({{ txn.id }}, {{ txn.abs_amount }})"
                        :checked="selected.has({{ txn.id }})"
                      >
                    </td>
                    <td class="px-3 py-2">{{ txn.date|date:"M j, Y" }}</td>
                    <td class="px-3 py-2">{{ txn.vendor.name|default:"-" }}</td>
                    <td class="px-3 py-2 text-slate-600">{{ txn.description|truncatewords:8 }}</td>
                    <td class="px-3 py-2 text-right">{{ txn.abs_amount|floatformat:2|intcomma }}</td>
                    <td class="px-3 py-2 text-right">
                      <input
                        type="number"
                        step="0.01"
                        name="match_txn_{{ txn.id }}"
                        x-model.number="amounts[{{ txn.id }}]"
                        :disabled="!selected.has({{ txn.id }})"
                        class="w-24 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500 disabled:bg-slate-100"
                        @input="updateTotal()"
                      >
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}

    {% if not best_matches and not other_transactions %}
      <div class="text-xs text-slate-500">No matching transactions found.</div>
    {% endif %}

    <div class="flex items-center justify-between rounded-md border border-slate-200 bg-slate-50 px-4 py-3">
      <div class="text-xs text-slate-700">
        <span class="font-semibold">Total Selected:</span>
        <span x-text="formatMoney(totalSelected)"></span>
        <span class="mx-2">·</span>
        <span class="font-semibold">Remaining After:</span>
        <span x-text="formatMoney(remaining - totalSelected)" :class="{ 'text-rose-600': totalSelected > remaining, 'text-emerald-600': totalSelected > 0 && totalSelected <= remaining }"></span>
      </div>
      <div class="flex items-center gap-2">
        <button
          type="button"
          @click="clearAll()"
          class="rounded-md border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50"
        >
          Clear All
        </button>
        <button
          type="submit"
          :disabled="totalSelected === 0"
          class="rounded-md bg-indigo-600 px-4 py-1.5 text-xs font-medium text-white hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed"
        >
          Apply Matches
        </button>
      </div>
    </div>
  </form>

  <p class="text-xs text-slate-500">
    Select one or more transactions and specify amounts. You can match multiple partial payments. Unmatching can be done from the bill detail page.
  </p>
</div>

<script>
  function matchManager(billId, remainingBalance) {
    return {
      billId,
      remaining: remainingBalance,
      selected: new Set(),
      amounts: {},
      totalSelected: 0,

      toggleTransaction(txnId, txnAmount) {
        if (this.selected.has(txnId)) {
          this.selected.delete(txnId);
          delete this.amounts[txnId];
        } else {
          this.selected.add(txnId);
          this.amounts[txnId] = Math.min(txnAmount, this.remaining);
        }
        this.updateTotal();
      },

      updateTotal() {
        this.totalSelected = Array.from(this.selected).reduce((sum, txnId) => {
          return sum + (parseFloat(this.amounts[txnId]) || 0);
        }, 0);
      },

      clearAll() {
        this.selected.clear();
        this.amounts = {};
        this.totalSelected = 0;
      },

      validateMatches() {
        if (this.totalSelected === 0) {
          alert("Please select at least one transaction.");
          return false;
        }
        if (this.totalSelected > this.remaining) {
          alert(`Total selected (${this.formatMoney(this.totalSelected)}) exceeds remaining balance (${this.formatMoney(this.remaining)}).`);
          return false;
        }
        return true;
      },

      formatMoney(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return "$0.00";
        return "$" + num.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      },
    };
  }
</script>
