{% extends "fincore/base.html" %}
{% load humanize %}
{% block title %}Invoice {{ invoice.number }} Â· Fincore{% endblock %}

{% block content %}
<div class="space-y-4 flex flex-col h-full">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">Invoice {{ invoice.number }}</h1>
      <p class="text-sm text-slate-500">Status: {{ invoice.status|capfirst }}</p>
    </div>
    <div class="flex items-center gap-2">
      <a class="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50" href="{% url 'fincore:sales_invoice_edit' invoice.id %}">Edit</a>
      <a class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700" href="{% url 'fincore:sales_transactions_list' %}">Back</a>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-3">
    <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
      <div class="text-xs text-slate-500">Customer</div>
      <div class="font-medium text-slate-900">{{ invoice.customer.name }}</div>
      <div class="mt-3 text-xs text-slate-500">Account</div>
      <div class="font-medium text-slate-900">{{ invoice.account.name }}</div>
      <div class="mt-3 text-xs text-slate-500">Invoice date</div>
      <div class="font-medium text-slate-900">{{ invoice.date|date:"M j, Y" }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
      <div class="text-xs text-slate-500">Subtotal</div>
      <div class="font-medium text-slate-900">{{ invoice.subtotal|floatformat:2|intcomma }}</div>
      <div class="mt-3 text-xs text-slate-500">Tax rate</div>
      <div class="font-medium text-slate-900">{{ invoice.tax_rate|floatformat:2 }}%</div>
      <div class="mt-3 text-xs text-slate-500">Tax excluded</div>
      <div class="font-medium text-slate-900">{{ invoice.tax_exclude|yesno:"Yes,No" }}</div>
      <div class="mt-3 text-xs text-slate-500">Tax Total</div>
      <div class="font-medium text-slate-900">{{ invoice.tax_total|floatformat:2|intcomma }}</div>
      <div class="mt-3 text-xs text-slate-500">Total</div>
      <div class="font-semibold text-slate-900">{{ invoice.total|floatformat:2|intcomma }}</div>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
      <div class="text-xs text-slate-500">Paid</div>
      <div class="font-medium text-slate-900">{{ invoice.paid_amount|floatformat:2|intcomma }}</div>
      <div class="mt-3 text-xs text-slate-500">Remaining</div>
      <div class="font-semibold text-slate-900">{{ invoice.remaining_balance|floatformat:2|intcomma }}</div>
    </div>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
    <div class="overflow-auto">
      <table class="min-w-full table-auto text-sm text-slate-800">
        <thead class="bg-slate-50 text-xs font-medium text-slate-700 border-b border-slate-200">
          <tr>
            <th class="py-2 px-4 text-left">Category</th>
            <th class="py-2 px-4 text-left">Description</th>
            <th class="py-2 px-4 text-right">Amount</th>
            <th class="py-2 px-4 text-right">Tax</th>
            <th class="py-2 px-4 text-right">Line Total</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for item in invoice.items.all %}
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-2 text-xs text-slate-700">{{ item.category.name }}</td>
              <td class="px-4 py-2 text-xs text-slate-600">{{ item.description|default:"-" }}</td>
              <td class="px-4 py-2 text-right text-xs text-slate-700">{{ item.amount|floatformat:2|intcomma }}</td>
              <td class="px-4 py-2 text-right text-xs text-slate-700">{{ item.tax|floatformat:2|intcomma }}</td>
              <td class="px-4 py-2 text-right text-xs text-slate-900">{{ item.total|floatformat:2|intcomma }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
    <div class="border-b border-slate-200 bg-slate-50 px-4 py-2 text-xs font-semibold text-slate-600">Payments</div>
    <div class="overflow-auto">
      <table class="min-w-full table-auto text-sm text-slate-800">
        <thead class="bg-slate-50 text-xs font-medium text-slate-700 border-b border-slate-200">
          <tr>
            <th class="py-2 px-4 text-left">Matched At</th>
            <th class="py-2 px-4 text-left">Transaction</th>
            <th class="py-2 px-4 text-left">Account</th>
            <th class="py-2 px-4 text-right">Amount</th>
            <th class="py-2 px-4 text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% if payments %}
            {% for payment in payments %}
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-2 text-xs text-slate-600">{{ payment.matched_at|date:"M j, Y H:i" }}</td>
                <td class="px-4 py-2 text-xs text-slate-700">{{ payment.transaction.description|default:"-" }}</td>
                <td class="px-4 py-2 text-xs text-slate-600">{{ payment.transaction.account.name }}</td>
                <td class="px-4 py-2 text-right text-xs text-slate-900">{{ payment.amount|floatformat:2|intcomma }}</td>
                <td class="px-4 py-2 text-right text-xs">
                  <form method="post" action="{% url 'fincore:sales_invoice_payment_delete' payment.id %}">
                    {% csrf_token %}
                    <button type="submit" class="text-rose-600 hover:text-rose-700">Unmatch</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td class="px-4 py-4 text-sm text-slate-500" colspan="5">No payments matched yet.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {% if invoice.notes %}
    <div class="rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700">
      <div class="text-xs font-semibold text-slate-600">Notes</div>
      <p class="mt-1">{{ invoice.notes }}</p>
    </div>
  {% endif %}
</div>
{% endblock %}
