{% extends "fincore/base.html" %}
{% block title %}New Invoice Â· Fincore{% endblock %}

{% block content %}
<div class="space-y-4 flex flex-col h-full">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">New Invoice</h1>
      <p class="text-sm text-slate-500">Create a sales invoice with one or more line items.</p>
    </div>
  </div>

  {% if form_errors %}
    <div class="rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      <ul class="list-disc pl-4">
        {% for error in form_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm space-y-4">
    {% csrf_token %}
    <div class="grid gap-3 sm:grid-cols-2">
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Customer (payer)</span>
        <select name="customer_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">Select customer</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}" {% if customer.id|stringformat:'s' == request.POST.customer_id %}selected{% endif %}>{{ customer.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Account</span>
        <select name="account_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">Select account</option>
          {% for account in accounts %}
            <option value="{{ account.id }}" {% if account.id|stringformat:'s' == request.POST.account_id %}selected{% endif %}>{{ account.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Invoice date</span>
        <input type="date" name="date" value="{{ request.POST.date }}" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Due date</span>
        <input type="date" name="due_date" value="{{ request.POST.due_date }}" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
      </label>
    </div>

    <div class="overflow-hidden rounded-lg border border-slate-200">
      <table class="min-w-full text-sm text-slate-800">
        <thead class="bg-slate-50 text-xs font-medium text-slate-700">
          <tr>
            <th class="px-3 py-2 text-left">Category</th>
            <th class="px-3 py-2 text-left">Description</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2 text-right">Tax</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for row in item_rows %}
            <tr class="hover:bg-slate-50">
              <td class="px-3 py-2">
                <select name="item_category_{{ forloop.counter }}" class="w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
                  <option value="">Select category</option>
                  {% for category in categories %}
                    <option value="{{ category.id }}" {% if row.category_id|add:'' == category.id|add:'' %}selected{% endif %}>{{ category.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="px-3 py-2">
                <input type="text" name="item_description_{{ forloop.counter }}" value="{{ row.description }}" class="w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional">
              </td>
              <td class="px-3 py-2 text-right">
                <input type="number" step="0.01" name="item_amount_{{ forloop.counter }}" value="{{ row.amount }}" class="w-24 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00">
              </td>
              <td class="px-3 py-2 text-right">
                <input type="number" step="0.01" name="item_tax_{{ forloop.counter }}" value="{{ row.tax }}" class="w-24 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00">
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="text-xs text-slate-500">Totals are calculated on save. Amounts can be negative for adjustments.</p>

    <label class="space-y-1 text-xs font-medium text-slate-600">
      <span>Notes</span>
      <textarea name="notes" rows="3" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional">{{ request.POST.notes }}</textarea>
    </label>

    <div class="flex items-center justify-end gap-2">
      <a href="{% url 'fincore:sales_transactions_list' %}" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50">Cancel</a>
      <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700">Save Invoice</button>
    </div>
  </form>
</div>
{% endblock %}
