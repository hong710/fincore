{% extends "fincore/base.html" %}
{% block title %}New Invoice · Fincore{% endblock %}

{% block content %}
<div class="space-y-4 flex flex-col h-full">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-semibold text-slate-900">New Invoice</h1>
      <p class="text-sm text-slate-500">Create a sales invoice with line items.</p>
      <p class="text-xs text-slate-500">Invoice #: (assigned on save)</p>
    </div>
  </div>

  {% if form_errors %}
    <div class="rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      <ul class="list-disc pl-4">
        {% for error in form_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {{ item_rows|json_script:"invoice-line-items" }}
  <form method="post" class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm space-y-4" x-data="invoiceForm()">
    {% csrf_token %}
    <input type="hidden" name="item_count" :value="rows.length">
    <div class="grid gap-3 sm:grid-cols-2">
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Customer (payer)</span>
        <select name="customer_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">Select customer</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}" {% if customer.id|stringformat:'s' == request.POST.customer_id %}selected{% endif %}>{{ customer.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Account</span>
        <select name="account_id" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">Select account</option>
          {% for account in accounts %}
            <option value="{{ account.id }}" {% if account.id|stringformat:'s' == request.POST.account_id %}selected{% endif %}>{% if account.parent_id %}• {% endif %}{{ account.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Invoice date</span>
        <input type="date" name="date" value="{{ request.POST.date }}" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500">
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Tax rate (%)</span>
        <input
          type="number"
          step="0.01"
          name="tax_rate"
          value="{{ tax_rate }}"
          class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500"
          x-model.number="taxRate"
          {% if tax_rate_locked %}disabled{% endif %}
        >
      </label>
      <label class="space-y-1 text-xs font-medium text-slate-600">
        <span>Exclude tax</span>
        <div class="flex items-center gap-2">
          <input type="hidden" name="tax_exclude" value="0">
          <input
            type="checkbox"
            name="tax_exclude"
            value="1"
            class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
            {% if tax_exclude %}checked{% endif %}
            {% if tax_rate_locked %}disabled{% endif %}
          >
          <span class="text-xs text-slate-500">Skip tax for the whole invoice.</span>
        </div>
      </label>
    </div>

    <div class="overflow-hidden rounded-lg border border-slate-200">
      <table class="min-w-full text-sm text-slate-800">
        <thead class="bg-slate-50 text-xs font-medium text-slate-700">
          <tr>
            <th class="px-3 py-2 text-left">Category</th>
            <th class="px-3 py-2 text-left">Description</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2 text-center">Exclude Tax</th>
            <th class="px-3 py-2 text-right">Tax</th>
            <th class="px-3 py-2 text-right">Line Total</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          <template x-for="(row, index) in rows" :key="index">
            <tr class="hover:bg-slate-50">
              <td class="px-3 py-2">
                <select :name="`item_category_${index + 1}`" class="w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model="row.category_id">
                  <option value="">Select category</option>
                  {% regroup categories by kind as grouped_categories %}
                  {% for group in grouped_categories %}
                    <optgroup label="{{ group.grouper|upper }}">
                      {% for category in group.list %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                      {% endfor %}
                    </optgroup>
                  {% endfor %}
                </select>
              </td>
              <td class="px-3 py-2">
                <input type="text" :name="`item_description_${index + 1}`" class="w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional" x-model="row.description">
              </td>
              <td class="px-3 py-2 text-right">
                <input type="number" step="0.01" :name="`item_amount_${index + 1}`" class="w-24 rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="0.00" x-model="row.amount">
              </td>
              <td class="px-3 py-2 text-center">
                <input type="hidden" :name="`item_tax_exempt_${index + 1}`" :value="row.tax_exempt ? '1' : ''">
                <input type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" x-model="row.tax_exempt">
              </td>
              <td class="px-3 py-2 text-right">
                <input type="text" class="w-24 rounded-md border border-slate-200 bg-slate-100 px-2 py-1 text-xs text-slate-700 text-right" :value="formatMoney(rowTax(row))" readonly>
              </td>
              <td class="px-3 py-2 text-right">
                <div class="flex items-center justify-end gap-2">
                  <span class="text-xs text-slate-700" x-text="formatMoney(rowTotal(row))"></span>
                  <button type="button" class="rounded-md border border-slate-200 px-2 py-1 text-[11px] text-slate-600 hover:bg-slate-100" @click="removeRow(index)" :disabled="rows.length === 1">Remove</button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="flex items-center justify-between">
      <p class="text-xs text-slate-500">Totals are calculated on save. Amounts can be negative for adjustments.</p>
      <button type="button" class="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50" @click="addRow()">+ Add Line Item</button>
    </div>

    <div class="flex justify-end">
      <div class="w-full max-w-xs space-y-2 rounded-md border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
        <div class="flex items-center justify-between">
          <span>Subtotal</span>
          <span x-text="formatMoney(subtotal())"></span>
        </div>
        <div class="flex items-center justify-between">
          <span>Total Tax</span>
          <span x-text="formatMoney(totalTax())"></span>
        </div>
        <div class="flex items-center justify-between font-semibold text-slate-900">
          <span>Grand Total</span>
          <span x-text="formatMoney(grandTotal())"></span>
        </div>
      </div>
    </div>

    <label class="space-y-1 text-xs font-medium text-slate-600">
      <span>Notes</span>
      <textarea name="notes" rows="3" class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Optional">{{ request.POST.notes }}</textarea>
    </label>

    <div class="flex items-center justify-end gap-2">
      <a href="{% url 'fincore:sales_transactions_list' %}" class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-medium text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50">Cancel</a>
      <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700">Save Invoice</button>
    </div>
  </form>
</div>
<script>
  function invoiceForm() {
    const rows = JSON.parse(
      document.getElementById("invoice-line-items").textContent
    );
    return {
      rows: rows.length ? rows : [{ category_id: "", description: "", amount: "", tax_exempt: false }],
      taxRate: Number("{{ tax_rate }}") || 7.75,
      taxExclude: {{ tax_exclude|yesno:"true,false" }},
      taxRateLocked: {{ tax_rate_locked|yesno:"true,false" }},
      addRow() {
        this.rows.push({ category_id: "", description: "", amount: "", tax_exempt: false });
      },
      removeRow(index) {
        if (this.rows.length <= 1) return;
        this.rows.splice(index, 1);
      },
      parseAmount(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num : 0;
      },
      rowTax(row) {
        if (this.taxExclude || row.tax_exempt) return 0;
        const amount = this.parseAmount(row.amount);
        return amount * (this.taxRate / 100);
      },
      rowTotal(row) {
        const amount = this.parseAmount(row.amount);
        return amount + this.rowTax(row);
      },
      subtotal() {
        return this.rows.reduce(
          (sum, row) => sum + this.parseAmount(row.amount),
          0
        );
      },
      totalTax() {
        return this.rows.reduce((sum, row) => sum + this.rowTax(row), 0);
      },
      grandTotal() {
        return this.subtotal() + this.totalTax();
      },
      formatMoney(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return "0.00";
        return num.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      },
    };
  }
</script>
{% endblock %}
