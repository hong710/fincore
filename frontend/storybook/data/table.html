<section class="space-y-4 p-4 text-slate-800 min-h-screen" x-data="tableDemo()">
  <h1 class="text-lg font-semibold text-slate-900">Transactions</h1>

  <div class="space-y-4 rounded-lg border border-slate-200 bg-white p-4 shadow-sm h-full min-h-[70vh] flex flex-col">
    <div class="overflow-hidden rounded-lg border border-slate-200 flex-1 min-h-[70vh]">
      <div class="overflow-x-auto h-full min-h-[60vh]">
        <table class="min-w-full text-sm text-slate-800 h-full">
          <thead class="bg-slate-50 text-xs font-medium text-slate-700 border-b border-slate-200">
            <tr>
              <th class="py-1.5 px-3 text-left align-top w-12">#</th>
              <th class="py-1.5 px-3 text-left align-top">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-slate-700">Date</span>
                  <div class="hs-dropdown relative inline-flex z-20 [--placement:bottom-left] [--auto-close:inside]">
                    <button x-ref="demoDateBtn" id="demo-date-filter" type="button" class="hs-dropdown-toggle inline-flex items-center rounded-md border bg-white px-2 py-1 text-xs shadow-sm hover:bg-slate-50" :class="filterActive('date') ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-700'">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" :class="filterActive('date') ? 'text-indigo-700 fill-current' : 'text-slate-500 fill-none'">
                        <path d="M3 4.5h18L14.25 12v5.25l-4.5 2.25V12L3 4.5Z"/>
                      </svg>
                    </button>
                    <div class="hs-dropdown-menu hidden z-50 mt-2 w-60 space-y-3 rounded-md border border-slate-200 bg-white p-3 shadow-md" aria-labelledby="demo-date-filter">
                      <div class="grid grid-cols-2 gap-2 text-xs font-medium text-slate-700">
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='this_month' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('this_month')">This month</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='last_month' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('last_month')">Last month</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='q1' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('q1')">1st quarter</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='q2' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('q2')">2nd quarter</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='q3' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('q3')">3rd quarter</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='q4' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('q4')">4th quarter</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='this_year' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('this_year')">This year</button>
                        <button type="button" class="rounded-md border px-2 py-1 transition hover:bg-slate-50" :class="draft.dateRange.type==='quick' && draft.dateRange.key==='last_year' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="selectQuickRange('last_year')">Last year</button>
                      </div>
                      <div class="space-y-2 text-xs text-slate-700">
                        <p class="font-medium">Custom range</p>
                        <div class="space-y-2">
                          <label class="relative block w-full">
                            <span class="absolute left-3 top-2 text-[11px] font-semibold uppercase tracking-wide text-slate-400">From</span>
                            <input type="date" class="w-full rounded-md border border-slate-200 px-3 pt-6 pb-2 text-xs font-semibold text-slate-800 placeholder:font-semibold placeholder:text-slate-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model="draft.dateRange.from" @input="draft.dateRange.type='custom'">
                          </label>
                          <label class="relative block w-full">
                            <span class="absolute left-3 top-2 text-[11px] font-semibold uppercase tracking-wide text-slate-400">To</span>
                            <input type="date" class="w-full rounded-md border border-slate-200 px-3 pt-6 pb-2 text-xs font-semibold text-slate-800 placeholder:font-semibold placeholder:text-slate-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model="draft.dateRange.to" @input="draft.dateRange.type='custom'">
                          </label>
                        </div>
                      </div>
                      <div class="inline-flex rounded-md border border-slate-200 text-xs text-slate-700">
                        <button type="button" class="px-2 py-1 hover:bg-slate-50" @click="setSort('date','asc')">Sort A→Z</button>
                        <span class="block w-px bg-slate-200"></span>
                        <button type="button" class="px-2 py-1 hover:bg-slate-50" @click="setSort('date','desc')">Sort Z→A</button>
                      </div>
                      <div class="flex justify-end gap-2 pt-1">
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="resetDraft('date'); $refs.demoDateBtn?.click()">Cancel</button>
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="filters.date.range={type:'all',key:'',from:'',to:''}; resetDraft('date'); $refs.demoDateBtn?.click()">Clear</button>
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-1 text-xs font-medium text-white hover:bg-indigo-700" @click="applyDraft('date'); $refs.demoDateBtn?.click()">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              <th class="py-1.5 px-3 text-left align-top">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-slate-700">Description</span>
                  <div class="relative z-20" x-data="{ open: false }" @keydown.escape.window="open=false">
                    <button type="button" class="inline-flex items-center rounded-md border bg-white px-2 py-1 text-xs shadow-sm hover:bg-slate-50" :class="filterActive('description') ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="open=!open">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" :class="filterActive('description') ? 'text-indigo-700 fill-current' : 'text-slate-500 fill-none'">
                        <path d="M3 4.5h18L14.25 12v5.25l-4.5 2.25V12L3 4.5Z"/>
                      </svg>
                    </button>
                    <div x-cloak x-show="open" @click.outside="open=false" class="absolute right-0 z-50 mt-2 w-64 rounded-md border border-slate-200 bg-white p-3 shadow-md space-y-2">
                      <div class="relative">
                        <input type="text" placeholder="Search descriptions" class="w-full rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model="filters.description.search">
                      </div>
                      <div class="flex items-center gap-2 text-xs text-slate-600">
                        <button type="button" class="rounded-md border border-slate-200 px-2 py-1 hover:bg-slate-50" @click="selectAll('description')">Select all</button>
                        <button type="button" class="rounded-md border border-slate-200 px-2 py-1 hover:bg-slate-50" @click="unselectAll('description')">Unselect all</button>
                      </div>
                      <div class="max-h-40 space-y-1 overflow-y-auto">
                        <template x-for="opt in filteredDescriptionOptions()" :key="opt">
                          <label class="flex items-center gap-2 text-xs text-slate-700">
                            <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" :value="opt" x-model="draft.description">
                            <span x-text="opt"></span>
                          </label>
                        </template>
                      </div>
                      <div class="inline-flex rounded-md border border-slate-200 text-xs text-slate-700">
                        <button type="button" class="px-2 py-1 hover:bg-slate-50" @click="setSort('description','asc')">Sort A→Z</button>
                        <button type="button" class="border-l border-slate-200 px-2 py-1 hover:bg-slate-50" @click="setSort('description','desc')">Sort Z→A</button>
                      </div>
                      <div class="flex justify-end gap-2 pt-1">
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="resetDraft('description'); open=false">Cancel</button>
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-1 text-xs font-medium text-white hover:bg-indigo-700" @click="applyDraft('description'); open=false">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              <th class="py-1.5 px-3 text-left align-top">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-slate-700">Categories</span>
                  <div class="relative z-20" x-data="{ open: false }" @keydown.escape.window="open=false">
                    <button type="button" class="inline-flex items-center rounded-md border bg-white px-2 py-1 text-xs shadow-sm hover:bg-slate-50" :class="filterActive('category') ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="open=!open">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" :class="filterActive('category') ? 'text-indigo-700 fill-current' : 'text-slate-500 fill-none'">
                        <path d="M3 4.5h18L14.25 12v5.25l-4.5 2.25V12L3 4.5Z"/>
                      </svg>
                    </button>
                    <div x-cloak x-show="open" @click.outside="open=false" class="absolute right-0 z-50 mt-2 w-64 rounded-md border border-slate-200 bg-white p-3 shadow-md space-y-2">
                      <div class="relative">
                        <input type="text" placeholder="Search category" class="w-full rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model="filters.category.search">
                      </div>
                      <div class="flex items-center gap-2 text-xs text-slate-600">
                        <button type="button" class="rounded-md border border-slate-200 px-2 py-1 hover:bg-slate-50" @click="selectAll('category')">Select all</button>
                        <button type="button" class="rounded-md border border-slate-200 px-2 py-1 hover:bg-slate-50" @click="unselectAll('category')">Unselect all</button>
                      </div>
                      <div class="max-h-40 space-y-1 overflow-y-auto">
                        <template x-for="opt in filteredCategoryOptions()" :key="opt">
                          <label class="flex items-center gap-2 text-xs text-slate-700">
                            <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" :value="opt" x-model="draft.category">
                            <span x-text="opt"></span>
                          </label>
                        </template>
                      </div>
                      <div class="inline-flex rounded-md border border-slate-200 text-xs text-slate-700">
                        <button type="button" class="px-2 py-1 hover:bg-slate-50" @click="setSort('category','asc')">Sort A→Z</button>
                        <button type="button" class="border-l border-slate-200 px-2 py-1 hover:bg-slate-50" @click="setSort('category','desc')">Sort Z→A</button>
                      </div>
                      <div class="flex justify-end gap-2 pt-1">
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="resetDraft('category'); open=false">Cancel</button>
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-1 text-xs font-medium text-white hover:bg-indigo-700" @click="applyDraft('category'); open=false">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              <th class="py-1.5 px-3 text-left align-top">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-slate-700">Spent</span>
                  <div class="relative z-20" x-data="{ open: false }" @keydown.escape.window="open=false">
                    <button type="button" class="inline-flex items-center rounded-md border bg-white px-2 py-1 text-xs shadow-sm hover:bg-slate-50" :class="filterActive('spent') ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="open=!open">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" :class="filterActive('spent') ? 'text-indigo-700 fill-current' : 'text-slate-500 fill-none'">
                        <path d="M3 4.5h18L14.25 12v5.25l-4.5 2.25V12L3 4.5Z"/>
                      </svg>
                    </button>
                    <div x-cloak x-show="open" @click.outside="open=false" class="absolute right-0 z-50 mt-2 w-56 rounded-md border border-slate-200 bg-white p-3 shadow-md space-y-2">
                      <div class="flex items-center gap-2">
                        <input type="number" placeholder="Min" class="w-24 rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-800 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model.number="draft.spent.min">
                        <input type="number" placeholder="Max" class="w-24 rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-800 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model.number="draft.spent.max">
                      </div>
                      <div class="inline-flex rounded-md border border-slate-200 text-xs text-slate-700">
                        <button type="button" class="px-2 py-1 hover:bg-slate-50" @click="setSort('spent','asc')">Sort ↑</button>
                        <button type="button" class="border-l border-slate-200 px-2 py-1 hover:bg-slate-50" @click="setSort('spent','desc')">Sort ↓</button>
                      </div>
                      <div class="flex justify-end gap-2 pt-1">
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="resetDraft('spent'); open=false">Cancel</button>
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="filters.spent={min:null,max:null}; resetDraft('spent'); open=false">Clear</button>
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-1 text-xs font-medium text-white hover:bg-indigo-700" @click="applyDraft('spent'); open=false">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              <th class="py-1.5 px-3 text-left align-top">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-slate-700">Received</span>
                  <div class="relative z-20" x-data="{ open: false }" @keydown.escape.window="open=false">
                    <button type="button" class="inline-flex items-center rounded-md border bg-white px-2 py-1 text-xs shadow-sm hover:bg-slate-50" :class="filterActive('received') ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-700'" @click="open=!open">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" :class="filterActive('received') ? 'text-indigo-700 fill-current' : 'text-slate-500 fill-none'">
                        <path d="M3 4.5h18L14.25 12v5.25l-4.5 2.25V12L3 4.5Z"/>
                      </svg>
                    </button>
                    <div x-cloak x-show="open" @click.outside="open=false" class="absolute right-0 z-50 mt-2 w-56 rounded-md border border-slate-200 bg-white p-3 shadow-md space-y-2">
                      <div class="flex items-center gap-2">
                        <input type="number" placeholder="Min" class="w-24 rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-800 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model.number="draft.received.min">
                        <input type="number" placeholder="Max" class="w-24 rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-800 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" x-model.number="draft.received.max">
                      </div>
                      <div class="inline-flex rounded-md border border-slate-200 text-xs text-slate-700">
                        <button type="button" class="px-2 py-1 hover:bg-slate-50" @click="setSort('received','asc')">Sort ↑</button>
                        <button type="button" class="border-l border-slate-200 px-2 py-1 hover:bg-slate-50" @click="setSort('received','desc')">Sort ↓</button>
                      </div>
                      <div class="flex justify-end gap-2 pt-1">
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="resetDraft('received'); open=false">Cancel</button>
                        <button type="button" class="rounded-md border border-slate-200 px-3 py-1 text-xs text-slate-700 hover:bg-slate-50" @click="filters.received={min:null,max:null}; resetDraft('received'); open=false">Clear</button>
                        <button type="button" class="rounded-md bg-indigo-600 px-3 py-1 text-xs font-medium text-white hover:bg-indigo-700" @click="applyDraft('received'); open=false">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              <th class="py-1.5 px-3 text-right text-sm text-slate-500">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <template x-if="filteredAndSortedRows().length === 0">
              <tr>
                <td colspan="7" class="px-3 py-6 text-center text-sm text-slate-500">No data available</td>
              </tr>
            </template>
            <template x-for="(row, idx) in visibleRows()" :key="row.id">
              <tr class="hover:bg-slate-50 transition-colors">
                <td class="py-1.5 px-3 whitespace-nowrap text-xs text-slate-600" x-text="(pagination.page - 1) * pagination.pageSize + idx + 1"></td>
                <td class="py-1.5 px-3 whitespace-nowrap text-slate-800" x-text="row.date"></td>
                <td class="py-1.5 px-3 whitespace-nowrap font-medium text-slate-800" x-text="row.description"></td>
                <td class="py-1.5 px-3 whitespace-nowrap text-slate-800" x-text="row.category"></td>
                <td class="py-1.5 px-3 whitespace-nowrap text-slate-800" x-text="row.spentDisplay"></td>
                <td class="py-1.5 px-3 whitespace-nowrap text-slate-800" x-text="row.receivedDisplay"></td>
                <td class="py-1.5 px-3 whitespace-nowrap text-right text-sm font-medium"><button type="button" class="text-indigo-600 hover:text-indigo-700">Delete</button></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

      <div class="flex flex-wrap items-center justify-between gap-2 pt-2">
        <div class="flex items-center gap-3 text-sm text-slate-500">
          <label class="flex items-center gap-2">
            <span class="text-xs text-slate-500">Rows per page</span>
            <select class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700 focus:border-indigo-500 focus:ring-indigo-500" x-model.number="pagination.pageSize" @change="pagination.page=1">
              <template x-for="size in pagination.sizes" :key="size">
                <option :value="size" x-text="size"></option>
              </template>
            </select>
          </label>
        </div>
        <div class="flex items-center gap-3 text-sm text-slate-600">
          <span>Showing <span x-text="visibleRows().length"></span> of <span x-text="filteredAndSortedRows().length"></span> records</span>
          <div class="inline-flex items-center rounded-md border border-slate-200 text-xs text-slate-700 overflow-hidden">
            <button type="button" class="px-2 py-1 hover:bg-slate-50 disabled:opacity-50" :disabled="pagination.page === 1" @click="pagination.page = Math.max(1, pagination.page - 1)">Prev</button>
            <span class="border-l border-r border-slate-200 px-2 py-1" x-text="pagination.page + ' / ' + totalPages()"></span>
            <button type="button" class="px-2 py-1 hover:bg-slate-50 disabled:opacity-50" :disabled="pagination.page >= totalPages()" @click="pagination.page = Math.min(totalPages(), pagination.page + 1)">Next</button>
          </div>
        </div>
      </div>
  </div>
</section>

<script>
  function tableDemo() {
    return {
      rows: [
        { id: 1, date: "2024-10-12", description: "Client Invoice", category: "Income", spent: 0, received: 3200 },
        { id: 2, date: "2024-10-11", description: "Office Supplies", category: "Expense", spent: 180, received: 0 },
        { id: 3, date: "2024-10-10", description: "Subscription", category: "Expense", spent: 45, received: 0 },
        { id: 4, date: "2024-10-09", description: "Consulting Revenue", category: "Income", spent: 0, received: 1250 },
        { id: 5, date: "2024-10-09", description: "Bank Transfer", category: "Transfer", spent: 0, received: 500 },
        { id: 6, date: "2024-10-08", description: "Travel", category: "Expense", spent: 320, received: 0 },
      ].map((r) => ({ ...r, spentDisplay: r.spent ? `-$${r.spent.toLocaleString()}` : "-", receivedDisplay: r.received ? `+$${r.received.toLocaleString()}` : "-" })),
      filters: {
        date: { range: { type: "all", key: "", from: "", to: "" } },
        description: { selected: [], search: "" },
        category: { selected: [], search: "" },
        spent: { min: null, max: null },
        received: { min: null, max: null },
      },
      draft: {
        dateRange: { type: "all", key: "", from: "", to: "" },
        description: [],
        category: [],
        spent: { min: null, max: null },
        received: { min: null, max: null },
      },
      sort: { column: null, direction: null },
      pagination: { page: 1, pageSize: 25, sizes: [25, 50, 100] },
      uniqueDescriptions() {
        return Array.from(new Set(this.rows.map((r) => r.description))).sort();
      },
      uniqueCategories() {
        return Array.from(new Set(this.rows.map((r) => r.category))).sort();
      },
      filteredDescriptionOptions() {
        return this.uniqueDescriptions().filter((d) => d.toLowerCase().includes(this.filters.description.search.toLowerCase()));
      },
      filteredCategoryOptions() {
        return this.uniqueCategories().filter((c) => c.toLowerCase().includes(this.filters.category.search.toLowerCase()));
      },
      selectAll(type) {
        if (type === "description") this.draft.description = [...this.uniqueDescriptions()];
        if (type === "category") this.draft.category = [...this.uniqueCategories()];
      },
      unselectAll(type) {
        if (type === "description") this.draft.description = [];
        if (type === "category") this.draft.category = [];
      },
      applyDraft(type) {
        if (type === "date") this.filters.date.range = { ...this.draft.dateRange };
        if (type === "description") this.filters.description.selected = [...this.draft.description];
        if (type === "category") this.filters.category.selected = [...this.draft.category];
        if (type === "spent") { this.filters.spent.min = this.draft.spent.min || null; this.filters.spent.max = this.draft.spent.max || null; }
        if (type === "received") { this.filters.received.min = this.draft.received.min || null; this.filters.received.max = this.draft.received.max || null; }
      },
      resetDraft(type) {
        if (type === "date") this.draft.dateRange = { ...this.filters.date.range };
        if (type === "description") this.draft.description = [...this.filters.description.selected];
        if (type === "category") this.draft.category = [...this.filters.category.selected];
        if (type === "spent") this.draft.spent = { min: this.filters.spent.min, max: this.filters.spent.max };
        if (type === "received") this.draft.received = { min: this.filters.received.min, max: this.filters.received.max };
      },
      selectQuickRange(key) {
        this.draft.dateRange = { type: "quick", key, from: "", to: "" };
      },
      getRange(range) {
        if (range.type === "quick") {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth();
          const startEnd = (mStart, mEnd) => ({
            start: new Date(year, mStart, 1),
            end: new Date(year, mEnd + 1, 0, 23, 59, 59),
          });
          switch (range.key) {
            case "this_month":
              return startEnd(month, month);
            case "last_month":
              return startEnd(month - 1, month - 1);
            case "this_year":
              return startEnd(0, 11);
            case "last_year":
              return {
                start: new Date(year - 1, 0, 1),
                end: new Date(year - 1, 11, 31, 23, 59, 59),
              };
            case "q1":
              return startEnd(0, 2);
            case "q2":
              return startEnd(3, 5);
            case "q3":
              return startEnd(6, 8);
            case "q4":
              return startEnd(9, 11);
            default:
              return null;
          }
        }
        if (range.type === "custom") {
          const start = range.from ? new Date(range.from) : null;
          const end = range.to ? new Date(range.to + "T23:59:59") : null;
          if (!start && !end) return null;
          return { start, end };
        }
        return null;
      },
      setSort(column, direction) {
        this.sort = { column, direction };
      },
      filteredAndSortedRows() {
        let result = this.rows.filter((row) => {
          let dateOk = true;
          const range = this.getRange(this.filters.date.range);
          if (range) {
            const d = new Date(row.date + "T00:00:00");
            if (range.start && d < range.start) dateOk = false;
            if (range.end && d > range.end) dateOk = false;
          }
          const descOk = this.filters.description.selected.length === 0 || this.filters.description.selected.includes(row.description);
          const catOk = this.filters.category.selected.length === 0 || this.filters.category.selected.includes(row.category);
          const spentOk =
            (this.filters.spent.min == null || row.spent >= this.filters.spent.min) &&
            (this.filters.spent.max == null || row.spent <= this.filters.spent.max);
          const receivedOk =
            (this.filters.received.min == null || row.received >= this.filters.received.min) &&
            (this.filters.received.max == null || row.received <= this.filters.received.max);
          return dateOk && descOk && catOk && spentOk && receivedOk;
        });

        if (this.sort.column) {
          const dir = this.sort.direction === "desc" ? -1 : 1;
          result = [...result].sort((a, b) => {
            const va = a[this.sort.column];
            const vb = b[this.sort.column];
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
          });
        }
        return result;
      },
      totalPages() {
        return Math.max(1, Math.ceil(this.filteredAndSortedRows().length / this.pagination.pageSize));
      },
      visibleRows() {
        const total = this.filteredAndSortedRows();
        const page = Math.min(this.pagination.page, Math.max(1, Math.ceil(total.length / this.pagination.pageSize) || 1));
        const start = (page - 1) * this.pagination.pageSize;
        const end = start + this.pagination.pageSize;
        this.pagination.page = page;
        return total.slice(start, end);
      },
      filterActive(key) {
        if (key === "date") return this.filters.date.range.type !== "all";
        if (key === "description") return this.filters.description.selected.length > 0;
        if (key === "category") return this.filters.category.selected.length > 0;
        if (key === "spent") return this.filters.spent.min != null || this.filters.spent.max != null;
        if (key === "received") return this.filters.received.min != null || this.filters.received.max != null;
        return false;
      },
      filterSummary() {
        const parts = [];
        if (this.filters.date.range.type !== "all") {
          if (this.filters.date.range.type === "quick") parts.push(`Date: ${this.filters.date.range.key}`);
          if (this.filters.date.range.type === "custom") parts.push(`Date: ${this.filters.date.range.from || ""}→${this.filters.date.range.to || ""}`);
        }
        if (this.filters.description.selected.length) parts.push(`Desc: ${this.filters.description.selected.length}`);
        if (this.filters.category.selected.length) parts.push(`Cat: ${this.filters.category.selected.length}`);
        if (this.filters.spent.min != null || this.filters.spent.max != null) parts.push(`Spent: ${this.filters.spent.min || ""}-${this.filters.spent.max || ""}`);
        if (this.filters.received.min != null || this.filters.received.max != null) parts.push(`Recv: ${this.filters.received.min || ""}-${this.filters.received.max || ""}`);
        return parts.length ? parts.join(", ") : "No filters";
      },
    };
  }
</script>
